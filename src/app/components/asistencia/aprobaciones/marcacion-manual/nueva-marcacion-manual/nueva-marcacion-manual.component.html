<!-- Contenedor principal con tema Fiori -->
<div class="bg-fiori-muted/30 pb-8">
  <div class="mx-auto">
    
    <!-- Header principal -->
    <div class="bg-gradient-to-r from-fiori-surface to-fiori-surface/80 rounded-2xl shadow-xl border border-fiori-border/30 overflow-hidden backdrop-blur-sm">
      <!-- Indicador de pasos elegante -->
      <div class="px-8 py-6">
        <div class="flex items-center justify-center">
          <!-- Paso 1 -->
          <div class="flex items-center">
            <div class="relative">
              <div class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg transition-all duration-300"
                   [class]="currentStep >= 1 ? 'bg-gradient-to-br from-fiori-primary to-fiori-secondary text-white shadow-fiori-primary/30' : 'bg-fiori-muted text-fiori-subtext'">
                <span class="text-base font-semibold">1</span>
              </div>
              <div *ngIf="currentStep >= 1" class="absolute -top-1 -right-1 w-4 h-4 bg-fiori-success rounded-full flex items-center justify-center">
                <lucide-icon name="check" class="w-2.5 h-2.5 text-white"></lucide-icon>
              </div>
            </div>
            <div class="ml-4">
              <span class="block text-base font-semibold transition-colors duration-200"
                    [class]="currentStep >= 1 ? 'text-fiori-text' : 'text-fiori-subtext'">
                Seleccionar Empleados
              </span>
              <span class="text-xs text-fiori-subtext">Filtrar y elegir empleados</span>
            </div>
          </div>
          
          <!-- Conectores elegantes -->
          <div class="flex-1 mx-8 relative">
            <div class="h-0.5 bg-fiori-border rounded-full"></div>
            <div class="h-0.5 bg-gradient-to-r from-fiori-primary to-fiori-secondary rounded-full transition-all duration-500"
                 [style.width]="currentStep >= 2 ? '100%' : '0%'"></div>
          </div>
          
          <!-- Paso 2 -->
          <div class="flex items-center">
            <div class="relative">
              <div class="flex items-center justify-center w-12 h-12 rounded-full shadow-lg transition-all duration-300"
                   [class]="currentStep >= 2 ? 'bg-gradient-to-br from-fiori-primary to-fiori-secondary text-white shadow-fiori-primary/30' : 'bg-fiori-muted text-fiori-subtext'">
                <span class="text-base font-semibold">2</span>
              </div>
              <div *ngIf="currentStep >= 2" class="absolute -top-1 -right-1 w-4 h-4 bg-fiori-warning rounded-full flex items-center justify-center">
                <lucide-icon name="clock" class="w-2.5 h-2.5 text-white"></lucide-icon>
              </div>
            </div>
            <div class="ml-4">
              <span class="block text-base font-semibold transition-colors duration-200"
                    [class]="currentStep >= 2 ? 'text-fiori-text' : 'text-fiori-subtext'">
                Registrar Marcación
              </span>
              <span class="text-xs text-fiori-subtext">Detalles de marcación</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paso 1: Selección de empleados -->
    <div *ngIf="currentStep === 1" class="space-y-6">
      
      <!-- Filtros de búsqueda -->
      <div class="bg-fiori-surface rounded-xl shadow-lg border border-fiori-border/50" style="overflow: visible;">
        <div class="px-6 py-5">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-gradient-to-br from-fiori-primary to-fiori-secondary rounded-lg flex items-center justify-center">
              <lucide-icon name="filter" class="w-4 h-4 text-white"></lucide-icon>
            </div>
            <h3 class="text-base font-semibold text-fiori-text">Filtros de búsqueda</h3>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Departamento Autocomplete (copiado exacto de empleado.component.html) -->
            <div class="relative">
              <label class="block text-sm font-medium text-fiori-subtext mb-2">Departamento</label>
              <div class="relative">
                <input type="text"
                       [(ngModel)]="departamentoSearchTerm"
                       (input)="onDepartamentoSearchChange($event)"
                       (focus)="showDepartamentoDropdown = true"
                       (blur)="onDepartamentoBlur()"
                       (keydown)="onDepartamentoKeydown($event)"
                       placeholder="Buscar departamento..."
                       class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm transition-all duration-200 hover:border-fiori-primary/50">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                  <div class="w-5 h-5 bg-fiori-primary/10 rounded-md flex items-center justify-center">
                    <lucide-icon name="building" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                  </div>
                </div>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                  <lucide-icon name="chevron-down" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
                </div>
              </div>
              
              <!-- Dropdown -->
              <div *ngIf="showDepartamentoDropdown" 
                   class="absolute z-[9999] w-full mt-1 bg-white border border-fiori-border/20 rounded-xl shadow-2xl max-h-64 overflow-y-auto"
                   style="z-index: 9999 !important;">
                
                <!-- Opción "Todas las áreas" -->
                <div class="px-4 py-3 cursor-pointer hover:bg-fiori-hover text-sm transition-colors border-b border-fiori-border"
                     [ngClass]="{'bg-fiori-primary text-white': highlightedDepartamentoIndex === -1}"
                     (mousedown)="selectTodasLasAreas()"
                     (mouseenter)="highlightedDepartamentoIndex = -1">
                  <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-lg flex items-center justify-center"
                         [ngClass]="highlightedDepartamentoIndex === -1 ? 'bg-white/20' : 'bg-fiori-primary/10'">
                      <lucide-icon name="globe" class="w-3.5 h-3.5"
                                   [ngClass]="highlightedDepartamentoIndex === -1 ? 'text-white' : 'text-fiori-primary'"></lucide-icon>
                    </div>
                    <div>
                      <div class="font-medium text-fiori-text">Todas las áreas</div>
                      <div class="text-xs text-fiori-subtext">Mostrar todos los departamentos</div>
                    </div>
                  </div>
                </div>
                
                <!-- Opciones de departamentos -->
                <div *ngFor="let area of filteredDepartamentos; let i = index" 
                     class="px-4 py-3 cursor-pointer hover:bg-fiori-hover text-sm transition-colors"
                     [ngClass]="{'bg-fiori-primary text-white': highlightedDepartamentoIndex === i}"
                     (mousedown)="selectDepartamento(area)"
                     (mouseenter)="highlightedDepartamentoIndex = i">
                  <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-lg flex items-center justify-center"
                         [ngClass]="highlightedDepartamentoIndex === i ? 'bg-white/20' : 'bg-fiori-primary/10'">
                      <lucide-icon name="building" class="w-3.5 h-3.5"
                                   [ngClass]="highlightedDepartamentoIndex === i ? 'text-white' : 'text-fiori-primary'"></lucide-icon>
                    </div>
                    <div>
                      <div class="font-medium text-fiori-text">{{ area.descripcion }}</div>
                      <div class="text-xs text-fiori-subtext">ID: {{ area.areaId }}</div>
                    </div>
                  </div>
                </div>
                
                <div *ngIf="filteredDepartamentos.length === 0" class="px-4 py-3 text-sm text-fiori-subtext">
                  No se encontraron departamentos
                </div>
              </div>
            </div>
            
            <!-- Búsqueda de empleado -->
            <div class="relative">
              <label class="block text-sm font-medium text-fiori-subtext mb-2">Buscar empleado</label>
              <div class="relative flex gap-2">
                <div class="relative flex-1">
                  <input type="text" 
                         [(ngModel)]="filtroEmpleadoText"
                         (keyup.enter)="buscarEmpleados()"
                         placeholder="Nombre, apellido o documento"
                         class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm transition-all duration-200 hover:border-fiori-primary/50">
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                    <div class="w-5 h-5 bg-fiori-primary/10 rounded-md flex items-center justify-center">
                      <lucide-icon name="search" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                    </div>
                  </div>
                </div>
                <button type="button"
                        (click)="buscarEmpleados()"
                        class="px-4 py-3 bg-fiori-primary text-white rounded-xl hover:bg-fiori-secondary focus:ring-2 focus:ring-fiori-primary focus:ring-offset-1 transition-colors"
                        title="Buscar empleados">
                  <lucide-icon name="search" class="w-4 h-4"></lucide-icon>
                </button>
                <button type="button"
                        (click)="limpiarFiltroEmpleado()"
                        class="px-4 py-3 bg-fiori-muted text-fiori-text rounded-xl hover:bg-fiori-hover focus:ring-2 focus:ring-fiori-border focus:ring-offset-1 transition-colors"
                        title="Limpiar búsqueda">
                  <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados de búsqueda -->
      <div class="bg-fiori-surface rounded-2xl shadow-xl border border-fiori-border/50 overflow-hidden backdrop-blur-sm">
        <div class="px-6 py-5 border-b border-fiori-border/30 bg-gradient-to-r from-fiori-muted/50 to-fiori-muted/30">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-fiori-primary to-fiori-secondary rounded-xl flex items-center justify-center shadow-lg">
                <lucide-icon name="users" class="w-5 h-5 text-white"></lucide-icon>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-fiori-text">Empleados encontrados</h2>
                <span class="bg-gradient-to-r from-fiori-primary/10 to-fiori-secondary/10 text-fiori-primary px-3 py-1 rounded-full text-sm font-medium border border-fiori-primary/20">
                  {{ totalEmpleados }} empleados
                </span>
              </div>
            </div>
            <div *ngIf="empleadosSeleccionados.length > 0" class="flex items-center gap-3 bg-fiori-success/10 px-4 py-2 rounded-xl border border-fiori-success/20">
              <div class="w-8 h-8 bg-fiori-success rounded-lg flex items-center justify-center">
                <lucide-icon name="check-circle" class="w-4 h-4 text-white"></lucide-icon>
              </div>
              <div>
                <span class="text-sm text-fiori-success font-semibold">
                  {{ empleadosSeleccionados.length }} seleccionado{{ empleadosSeleccionados.length !== 1 ? 's' : '' }}
                </span>
                <div class="text-xs text-fiori-success/70">Listos para marcación</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading state -->
        <div *ngIf="loadingEmpleados" class="p-12 text-center">
          <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fiori-primary"></div>
            <div>
              <div class="text-fiori-text font-medium">Cargando empleados</div>
              <div class="text-fiori-subtext text-sm">Por favor espere...</div>
            </div>
          </div>
        </div>

        <!-- Tabla de empleados -->
        <div *ngIf="!loadingEmpleados" class="h-[400px] overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-fiori-muted border-b border-fiori-border sticky top-0 z-10">
              <tr>
                <th class="px-4 py-3 text-left">
                  <div class="flex items-center gap-2">
                    <input type="checkbox" 
                           [checked]="isAllSelected()"
                           [indeterminate]="isSomeSelected() && !isAllSelected()"
                           (change)="toggleSelectAll($event)"
                           class="w-4 h-4 text-fiori-primary bg-fiori-surface border-fiori-border rounded focus:ring-fiori-primary">
                    <span class="text-xs font-medium text-fiori-subtext uppercase">Seleccionar</span>
                  </div>
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-fiori-subtext uppercase">
                  <div class="flex items-center gap-2">
                    <lucide-icon name="id-card" class="w-4 h-4"></lucide-icon>
                    Documento
                  </div>
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-fiori-subtext uppercase">
                  <div class="flex items-center gap-2">
                    <lucide-icon name="user" class="w-4 h-4"></lucide-icon>
                    Empleado
                  </div>
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-fiori-subtext uppercase">
                  <div class="flex items-center gap-2">
                    <lucide-icon name="building" class="w-4 h-4"></lucide-icon>
                    Área
                  </div>
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-fiori-subtext uppercase">
                  <div class="flex items-center gap-2">
                    <lucide-icon name="clock" class="w-4 h-4"></lucide-icon>
                    Horarios
                  </div>
                </th>
              </tr>
            </thead>
            <tbody class="bg-fiori-surface divide-y divide-fiori-border">
              <tr *ngFor="let emp of empleados.data; trackBy: trackByEmpleado" 
                  class="hover:bg-fiori-hover transition-colors duration-200">
                
                <!-- Checkbox -->
                <td class="px-4 py-4">
                  <input type="checkbox" 
                         [checked]="isEmpleadoSeleccionado(emp)"
                         (change)="toggleSeleccionEmpleado(emp, $event)"
                         class="w-4 h-4 text-fiori-primary bg-fiori-surface border-fiori-border rounded focus:ring-fiori-primary">
                </td>
                
                <!-- Documento -->
                <td class="px-4 py-4">
                  <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
                      <lucide-icon name="badge" class="w-4 h-4 text-fiori-primary"></lucide-icon>
                    </div>
                    <span class="font-medium text-fiori-text">{{ emp.nroDoc }}</span>
                  </div>
                </td>
                
                <!-- Empleado -->
                <td class="px-4 py-4">
                  <div class="flex flex-col">
                    <span class="font-medium text-fiori-text">{{ emp.fullNameEmployee }}</span>
                    <span class="text-xs text-fiori-subtext">ID: {{ emp.nroDoc }}</span>
                  </div>
                </td>
                
                <!-- Área -->
                <td class="px-4 py-4">
                  <div class="inline-flex items-center gap-2 px-3 py-1 bg-fiori-muted text-fiori-text text-sm rounded-full border border-fiori-border">
                    <lucide-icon name="building" class="w-3 h-3 text-fiori-subtext"></lucide-icon>
                    <span>{{ emp.areaName || 'Sin área asignada' }}</span>
                  </div>
                </td>
                
                <!-- Horarios -->
                <td class="px-4 py-4">
                  <div class="flex items-center gap-2">
                    <button (click)="toggleExpandEmployee(emp)" 
                            class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-fiori-primary/10 text-fiori-primary rounded border border-fiori-primary/20 hover:bg-fiori-primary/20 transition-colors">
                      <lucide-icon name="clock" class="w-3 h-3"></lucide-icon>
                      <span>{{ emp.horarios.length || 0 }} horarios</span>
                      <lucide-icon [name]="expandedEmployee === emp ? 'chevron-up' : 'chevron-down'" 
                                   class="w-3 h-3"></lucide-icon>
                    </button>
                  </div>
                  
                  <!-- Horarios expandidos -->
                  <div *ngIf="expandedEmployee === emp && emp.horarios.length > 0" 
                       class="mt-3 space-y-2 border-t border-fiori-border pt-2">
                    <div *ngFor="let horario of getHorariosAgrupados(emp.horarios)" 
                         class="flex items-center justify-between bg-fiori-muted/50 p-2 rounded border border-fiori-border">
                      <div class="flex items-center gap-2">
                        <lucide-icon name="clock" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                        <span class="text-xs font-medium text-fiori-text">{{ horario.nameHora }}</span>
                      </div>
                      <span class="text-xs text-fiori-subtext">{{ horario.inTime }} - {{ horario.outTime }}</span>
                    </div>
                  </div>
                  
                  <div *ngIf="expandedEmployee === emp && (!emp.horarios || emp.horarios.length === 0)" 
                       class="mt-3 flex items-center gap-2 text-fiori-warning bg-fiori-warning/10 p-2 rounded border border-fiori-warning/20">
                    <lucide-icon name="warning" class="w-3 h-3"></lucide-icon>
                    <span class="text-xs">No tiene horarios asignados</span>
                  </div>
                </td>
              </tr>
              
              <!-- Estado vacío -->
              <tr *ngIf="empleados.data.length === 0">
                <td colspan="5" class="px-4 py-12 text-center">
                  <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-fiori-muted rounded-full flex items-center justify-center mb-4">
                      <lucide-icon name="people-off" class="w-8 h-8 text-fiori-subtext"></lucide-icon>
                    </div>
                    <h3 class="text-lg font-medium text-fiori-text mb-2">No se encontraron empleados</h3>
                    <p class="text-sm text-fiori-subtext">Intenta ajustar los filtros de búsqueda</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginador Fiori Genérico -->
        <app-fiori-paginator
          [totalRecords]="totalEmpleados"
          [pageSize]="pageSize"
          [pageNumber]="pageNumber"
          [loading]="loadingEmpleados"
          [pageSizeOptions]="[5, 10, 15, 25, 50]"
          [showAllOption]="false"
          (pageChange)="onPaginatorChange($event)">
        </app-fiori-paginator>
        
      </div>

    </div>

    <!-- Paso 2: Formulario de marcación -->
    <div *ngIf="currentStep === 2" class="space-y-6">
      
      <!-- Formulario de marcación elegante -->
      <div class="bg-gradient-to-br from-fiori-surface to-fiori-surface/80 rounded-2xl shadow-xl border border-fiori-border/50 overflow-hidden backdrop-blur-sm">
        
        <form [formGroup]="marcacionForm" class="p-6">
          
          <!-- Header elegante con empleados seleccionados -->
          <div class="flex items-center justify-between mb-6 pb-4 border-b border-fiori-border/30">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-fiori-warning to-fiori-warning/80 rounded-xl flex items-center justify-center shadow-lg">
                <lucide-icon name="clock" class="w-5 h-5 text-white"></lucide-icon>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-fiori-text">Detalles de marcación</h2>
                <p class="text-sm text-fiori-subtext">Complete la información de la marcación manual</p>
              </div>
            </div>
            <div class="flex items-center gap-3 bg-fiori-primary/10 px-4 py-2 rounded-xl border border-fiori-primary/20">
              <div class="w-8 h-8 bg-fiori-primary rounded-lg flex items-center justify-center">
                <lucide-icon name="users" class="w-4 h-4 text-white"></lucide-icon>
              </div>
              <div>
                <span class="text-sm text-fiori-primary font-semibold">{{ empleadosSeleccionados.length }} empleado{{ empleadosSeleccionados.length !== 1 ? 's' : '' }}</span>
                <div class="text-xs text-fiori-primary/70">Seleccionados</div>
              </div>
            </div>
          </div>
          
          <!-- Campos del formulario elegantes -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            
            <!-- Fecha -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-fiori-subtext">Fecha de marcación</label>
              <div class="relative group">
                <input type="date" 
                       formControlName="fechaMarcacion"
                       class="w-full pl-12 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm transition-all duration-200 hover:border-fiori-primary/50 group-hover:shadow-lg">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                  <div class="w-6 h-6 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
                    <lucide-icon name="calendar" class="w-3.5 h-3.5 text-fiori-primary"></lucide-icon>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Hora -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-fiori-subtext">Hora de marcación</label>
              <div class="relative group">
                <input type="time" 
                       formControlName="horaMarcacion"
                       class="w-full pl-12 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm transition-all duration-200 hover:border-fiori-primary/50 group-hover:shadow-lg">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                  <div class="w-6 h-6 bg-fiori-warning/10 rounded-lg flex items-center justify-center">
                    <lucide-icon name="clock" class="w-3.5 h-3.5 text-fiori-warning"></lucide-icon>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tipo de marcación -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-fiori-subtext">Tipo de marcación</label>
              <div class="relative group">
                <select formControlName="estadoMarcacion"
                        class="w-full pl-12 pr-10 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm appearance-none transition-all duration-200 hover:border-fiori-primary/50 group-hover:shadow-lg">
                  <option value="">Seleccionar tipo...</option>
                  <option value="entrada">🟢 Entrada</option>
                  <option value="salida">🔴 Salida</option>
                  <option value="salida_descanso">🟡 Salida Descanso</option>
                  <option value="entrada_descanso">🔵 Regreso Descanso</option>
                </select>
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                  <div class="w-6 h-6 bg-fiori-secondary/10 rounded-lg flex items-center justify-center">
                    <lucide-icon name="clock" class="w-3.5 h-3.5 text-fiori-secondary"></lucide-icon>
                  </div>
                </div>
                <lucide-icon name="chevron-down" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-fiori-subtext w-4 h-4 transition-transform group-focus-within:rotate-180"></lucide-icon>
              </div>
            </div>
          </div>

          <!-- Motivo e incidencias elegantes -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Motivo -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-fiori-subtext">Motivo de marcación <span class="text-fiori-error">*</span></label>
              <div class="relative group">
                <textarea formControlName="motivo"
                          rows="3"
                          placeholder="Describa el motivo de la marcación manual..."
                          class="w-full pl-12 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm resize-none transition-all duration-200 hover:border-fiori-primary/50 group-hover:shadow-lg"></textarea>
                <div class="absolute left-3 top-3">
                  <div class="w-6 h-6 bg-fiori-error/10 rounded-lg flex items-center justify-center">
                    <lucide-icon name="file-edit" class="w-3.5 h-3.5 text-fiori-error"></lucide-icon>
                  </div>
                </div>
              </div>
              <div class="text-xs text-fiori-subtext">Este campo es obligatorio</div>
            </div>

            <!-- Incidencias -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-fiori-subtext">Incidencias adicionales</label>
              <div class="relative group">
                <textarea formControlName="incidencias"
                          rows="3"
                          placeholder="Situaciones especiales, observaciones o incidencias..."
                          class="w-full pl-12 pr-4 py-3 border border-fiori-border rounded-xl bg-fiori-surface/50 focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary text-sm resize-none transition-all duration-200 hover:border-fiori-primary/50 group-hover:shadow-lg"></textarea>
                <div class="absolute left-3 top-3">
                  <div class="w-6 h-6 bg-fiori-warning/10 rounded-lg flex items-center justify-center">
                    <lucide-icon name="clipboard-list" class="w-3.5 h-3.5 text-fiori-warning"></lucide-icon>
                  </div>
                </div>
              </div>
              <div class="text-xs text-fiori-subtext">Información adicional (opcional)</div>
            </div>
          </div>
          
          <!-- Lista elegante de empleados seleccionados -->
          <div class="mt-6 pt-4 border-t border-fiori-border/30">
            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
                <lucide-icon name="users" class="w-3.5 h-3.5 text-fiori-primary"></lucide-icon>
              </div>
              <span class="text-sm font-semibold text-fiori-subtext">Empleados que recibirán la marcación:</span>
            </div>
            <div class="flex flex-wrap gap-2">
              <div *ngFor="let emp of empleadosSeleccionados | slice:0:5" 
                   class="inline-flex items-center gap-2 bg-gradient-to-r from-fiori-primary/10 to-fiori-secondary/10 px-3 py-2 rounded-xl border border-fiori-primary/20 transition-all hover:shadow-lg">
                <div class="w-6 h-6 bg-fiori-primary/20 rounded-lg flex items-center justify-center">
                  <lucide-icon name="user" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                </div>
                <span class="font-medium text-fiori-text text-sm">{{ emp.fullNameEmployee }}</span>
              </div>
              <div *ngIf="empleadosSeleccionados.length > 5"
                   class="inline-flex items-center gap-2 bg-fiori-muted/50 px-3 py-2 rounded-xl border border-fiori-border text-sm text-fiori-subtext">
                <div class="w-6 h-6 bg-fiori-muted rounded-lg flex items-center justify-center">
                  <span class="text-xs font-bold">+{{ empleadosSeleccionados.length - 5 }}</span>
                </div>
                <span>empleados más</span>
              </div>
            </div>
          </div>
        </form>
      </div>

    </div>

  </div>

  <!-- Barra de acciones flotante en el footer del modal -->
  <div class="bg-fiori-surface border-t border-fiori-border p-4 rounded-b-lg">
    
    <!-- Paso 1: Botón continuar -->
    <div *ngIf="currentStep === 1" class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-sm text-fiori-subtext">
          Paso 1 de 2 - Selección de empleados
        </div>
        <div *ngIf="empleadosSeleccionados.length > 0" class="flex items-center gap-2 px-3 py-1 bg-fiori-success/10 text-fiori-success rounded-full text-sm">
          <lucide-icon name="check-circle" class="w-4 h-4"></lucide-icon>
          <span class="font-medium">{{ empleadosSeleccionados.length }} seleccionado{{ empleadosSeleccionados.length !== 1 ? 's' : '' }}</span>
        </div>
      </div>
      
      <button (click)="nextStep()" 
              [disabled]="empleadosSeleccionados.length === 0"
              class="inline-flex items-center gap-2 px-6 py-3 bg-fiori-primary text-white text-sm font-medium rounded-lg hover:bg-fiori-secondary focus:ring-2 focus:ring-fiori-primary focus:ring-offset-1 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
        <span>Continuar</span>
        <lucide-icon name="chevron-right" class="w-4 h-4"></lucide-icon>
      </button>
    </div>

    <!-- Paso 2: Botones de navegación y guardar -->
    <div *ngIf="currentStep === 2" class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button (click)="previousStep()" 
                class="inline-flex items-center gap-2 px-4 py-2 text-sm border border-fiori-border rounded-lg hover:bg-fiori-hover transition-colors">
          <lucide-icon name="chevron-left" class="w-4 h-4"></lucide-icon>
          <span>Atrás</span>
        </button>
        <div class="text-sm text-fiori-subtext">
          Paso 2 de 2 - Detalles de marcación
        </div>
      </div>
      
      <button (click)="guardarMarcacion()" 
              [disabled]="marcacionForm.invalid || loadingGuardado"
              class="inline-flex items-center gap-2 px-6 py-3 bg-fiori-primary text-white text-sm font-medium rounded-lg hover:bg-fiori-secondary focus:ring-2 focus:ring-fiori-primary focus:ring-offset-1 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
        <lucide-icon [name]="loadingGuardado ? 'refresh-cw' : 'save'" 
                     [class]="loadingGuardado ? 'w-4 h-4 animate-spin' : 'w-4 h-4'"></lucide-icon>
        <span>{{ loadingGuardado ? 'Guardando...' : 'Guardar Marcación' }}</span>
      </button>
    </div>
  </div>


</div>