<mat-horizontal-stepper [linear]="true" #stepper class="bg-fiori-surface">
  <!-- Paso 1: Selección de empleado -->
  <mat-step [stepControl]="empleadoForm" title="Seleccionar Empleado">
    <form [formGroup]="empleadoForm" class="p-4">
      <!-- Header del paso -->
      <div class="mb-4">
        <div class="text-title text-fiori-text mb-1">Seleccionar Empleado</div>
        <div class="text-sm text-fiori-subtext">Busca y selecciona el empleado para registrar la marcación</div>
      </div>

      <!-- Filtros de búsqueda -->
      <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Departamento</mat-label>
          <mat-select formControlName="departamento">
            <mat-option value="">Todas las áreas</mat-option>
            <mat-option *ngFor="let area of departamentos" [value]="area.areaId">{{ area.descripcion }}</mat-option>
          </mat-select>
          <mat-icon matSuffix *ngIf="loadingAreas" class="animate-spin text-fiori-primary">refresh</mat-icon>
        </mat-form-field>
        
        <mat-form-field appearance="fill" class="w-full md:col-span-2">
          <mat-label>Buscar empleado</mat-label>
          <input matInput placeholder="Nombre, apellido o ID" formControlName="filtroEmpleado">
          <mat-icon matSuffix class="text-fiori-subtext">search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Botón de búsqueda -->
      <div class="mb-3 flex justify-end">
        <button mat-flat-button color="primary" type="button" (click)="buscarEmpleados()" 
                [disabled]="loadingEmpleados"
                class="btn-fiori flex items-center gap-2">
          <mat-icon *ngIf="!loadingEmpleados">search</mat-icon>
          <mat-icon *ngIf="loadingEmpleados" class="animate-spin">refresh</mat-icon>
          {{ loadingEmpleados ? 'Buscando...' : 'Buscar' }}
        </button>
      </div>

      <!-- Tabla de empleados -->
      <div class="card-fiori mb-4">
        <!-- Loading overlay para la tabla -->
        <div *ngIf="loadingEmpleados" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-fiori">
          <div class="flex flex-col items-center gap-3">
            <mat-spinner diameter="40"></mat-spinner>
            <span class="text-fiori-subtext">Cargando empleados...</span>
          </div>
        </div>
        
        <div class="overflow-auto max-h-[60vh] relative">
          <table mat-table [dataSource]="empleados" class="w-full">
            <!-- Columna de selección -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="w-12">
                <span class="text-label">Seleccionar</span>
              </th>
              <td mat-cell *matCellDef="let row" class="w-12">
                <mat-checkbox 
                  [checked]="isEmpleadoSeleccionado(row)" 
                  (change)="toggleSeleccionEmpleado(row, $event.checked)"
                  color="primary">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- ID Empleado -->
            <ng-container matColumnDef="idEmpleado">
              <th mat-header-cell *matHeaderCellDef>
                <span class="text-label">ID Empleado</span>
              </th>
              <td mat-cell *matCellDef="let row">
                <span class="font-medium text-fiori-text">{{ row.nroDoc }}</span>
              </td>
            </ng-container>

            <!-- Nombre -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>
                <span class="text-label">Nombre</span>
              </th>
              <td mat-cell *matCellDef="let row">
                <span class="text-fiori-text">{{ row.nombres }}</span>
              </td>
            </ng-container>

            <!-- Apellido -->
            <ng-container matColumnDef="apellido">
              <th mat-header-cell *matHeaderCellDef>
                <span class="text-label">Apellido</span>
              </th>
              <td mat-cell *matCellDef="let row">
                <span class="text-fiori-text">{{ row.apellidoPaterno }}</span>
              </td>
            </ng-container>

            <!-- Departamento -->
            <ng-container matColumnDef="departamento">
              <th mat-header-cell *matHeaderCellDef>
                <span class="text-label">Departamento</span>
              </th>
              <td mat-cell *matCellDef="let row">
                <span class="inline-block px-2 py-1 bg-fiori-muted text-fiori-text text-xs rounded-fiori border border-fiori-border">
                  {{ row.areaDescripcion || 'N/A' }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-fiori-muted"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                class="hover:bg-fiori-hover transition-colors duration-200 cursor-pointer">
            </tr>
          </table>
          
          <!-- Mensaje cuando no hay datos -->
          <div *ngIf="!loadingEmpleados && empleados.data.length === 0" class="text-center py-8 text-fiori-subtext">
            <mat-icon class="mb-2 text-4xl">group_off</mat-icon>
            <p>No se encontraron empleados</p>
          </div>
        </div>

        <!-- Paginación -->
        <div class="border-t border-fiori-border mt-3 pt-3">
          <mat-paginator 
            [length]="totalEmpleados" 
            [pageSize]="pageSize" 
            [pageIndex]="pageNumber - 1"
            (page)="onEmpleadoPage($event)" 
            [pageSizeOptions]="[5, 10, 20, 50]"
            [disabled]="loadingEmpleados"
            class="border-0">
          </mat-paginator>
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="flex justify-end">
        <button mat-flat-button color="primary" (click)="stepper.next()" 
                [disabled]="empleadosSeleccionados.length === 0"
                class="btn-fiori flex items-center gap-2">
          Continuar
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 2: Formulario de marcación -->
  <mat-step [stepControl]="marcacionForm" title="Registrar Marcación">
    <form [formGroup]="marcacionForm" class="p-4">
      <!-- Header del paso -->
      <div class="mb-4">
        <div class="text-title text-fiori-text mb-1">Registrar Marcación</div>
        <div class="text-sm text-fiori-subtext">Complete los detalles de la marcación</div>
      </div>

      <!-- Campos del formulario -->
      <div class="space-y-4">
        <!-- Fecha y hora -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Fecha de Marcación</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fechaMarcacion">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-icon matPrefix class="text-fiori-subtext mr-2">calendar_today</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Hora de Marcación</mat-label>
            <input matInput type="time" formControlName="horaMarcacion">
            <mat-icon matPrefix class="text-fiori-subtext mr-2">schedule</mat-icon>
          </mat-form-field>
        </div>

        <!-- Estado de marcación -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Tipo de Marcación</mat-label>
          <mat-select formControlName="estadoMarcacion">
            <mat-option value="entrada">
              <div class="flex items-center gap-2">
                <mat-icon class="text-fiori-success">login</mat-icon>
                Marcación de Entrada
              </div>
            </mat-option>
            <mat-option value="salida">
              <div class="flex items-center gap-2">
                <mat-icon class="text-fiori-error">logout</mat-icon>
                Marcación de Salida
              </div>
            </mat-option>
            <mat-option value="salida_descanso">
              <div class="flex items-center gap-2">
                <mat-icon class="text-fiori-warning">coffee</mat-icon>
                Salida a Descanso
              </div>
            </mat-option>
            <mat-option value="entrada_descanso">
              <div class="flex items-center gap-2">
                <mat-icon class="text-fiori-info">work</mat-icon>
                Entrada de Descanso
              </div>
            </mat-option>
          </mat-select>
          <mat-icon matPrefix class="text-fiori-subtext mr-2">access_time</mat-icon>
        </mat-form-field>

        <!-- Incidencias -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Incidencias</mat-label>
          <textarea matInput 
                    formControlName="incidencias" 
                    rows="2" 
                    placeholder="Describe cualquier incidencia o situación especial">
          </textarea>
          <mat-icon matPrefix class="text-fiori-subtext mr-2">report_problem</mat-icon>
        </mat-form-field>

        <!-- Motivo -->
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Motivo/Observaciones</mat-label>
          <textarea matInput 
                    formControlName="motivo" 
                    rows="2" 
                    placeholder="Motivo o observaciones adicionales">
          </textarea>
          <mat-icon matPrefix class="text-fiori-subtext mr-2">note</mat-icon>
        </mat-form-field>
      </div>

      <!-- Botones de navegación -->
      <div class="flex justify-between pt-4 border-t border-fiori-border mt-4">
        <button mat-stroked-button type="button" (click)="stepper.previous()" 
                class="btn-fiori-secondary flex items-center gap-2">
          <mat-icon>arrow_back</mat-icon>
          Atrás
        </button>
        
        <button mat-flat-button color="primary" type="submit" 
                (click)="guardarMarcacion()" 
                [disabled]="marcacionForm.invalid || loadingGuardado"
                class="btn-fiori flex items-center gap-2">
          <mat-icon *ngIf="!loadingGuardado">save</mat-icon>
          <mat-icon *ngIf="loadingGuardado" class="animate-spin">refresh</mat-icon>
          {{ loadingGuardado ? 'Guardando...' : 'Guardar Marcación' }}
        </button>
      </div>
    </form>
  </mat-step>
</mat-horizontal-stepper>