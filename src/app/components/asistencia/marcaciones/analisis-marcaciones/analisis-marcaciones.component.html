<div class="p-4 max-w-full h-screen flex flex-col">
  <!-- Header compacto con tema Fiori -->
  <div class="mb-4 flex items-center justify-between bg-fiori-surface p-4 rounded-lg shadow-fioriSm border border-fiori-border">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
        <lucide-icon name="bar-chart-3" class="w-5 h-5 text-fiori-primary"></lucide-icon>
      </div>
      <div>
        <h1 class="text-fiori-text font-semibold text-lg">Análisis de Marcaciones</h1>
        <div class="flex items-center gap-2 text-sm text-fiori-subtext">
          <lucide-icon name="database" class="w-4 h-4"></lucide-icon>
          <span>{{ totalCount | number }} registros encontrados</span>
        </div>
      </div>
    </div>
    <div class="flex gap-2">
      <!-- Download excel -->
      <button 
        (click)="downloadExcel()" 
        class="inline-flex items-center gap-2 px-3 py-2 text-sm bg-fiori-success/10 text-fiori-success border border-fiori-success/20 rounded-lg hover:bg-fiori-success/20 transition-colors">
        <lucide-icon name="download" class="w-4 h-4"></lucide-icon>
        Descargar
      </button>

      <!-- Excel -->
      <button 
        (click)="exportToExcel()" 
        class="inline-flex items-center gap-2 px-3 py-2 text-sm bg-fiori-success/10 text-fiori-success border border-fiori-success/20 rounded-lg hover:bg-fiori-success/20 transition-colors">
        <lucide-icon name="file-spreadsheet" class="w-4 h-4"></lucide-icon>
        Excel
      </button>
      <!-- PDF -->
      <button 
        (click)="exportToPDF()" 
        class="inline-flex items-center gap-2 px-3 py-2 text-sm bg-fiori-error/10 text-fiori-error border border-fiori-error/20 rounded-lg hover:bg-fiori-error/20 transition-colors">
        <lucide-icon name="file-text" class="w-4 h-4"></lucide-icon>
        PDF
      </button>
    </div>
  </div>

  <!-- Filtros compactos con tema Fiori -->
  <div class="mb-4 bg-fiori-surface rounded-lg shadow-fioriSm border border-fiori-border">
    <!-- Quick filters -->
    <div class="px-4 pt-3 pb-2 border-b border-fiori-border">
      <div class="flex flex-wrap items-center gap-2">
        <div class="flex items-center gap-1 mr-3">
          <lucide-icon name="filter" class="w-4 h-4 text-fiori-primary"></lucide-icon>
          <span class="text-sm font-medium text-fiori-text">Filtros rápidos:</span>
        </div>
        <button 
          (click)="applyQuickFilter('today')"
          [class]="getQuickFilterClass('today')"
          class="px-3 py-1.5 text-sm border rounded-lg transition-colors hover:shadow-fioriSm">
          <lucide-icon name="calendar-days" class="w-3 h-3 mr-1"></lucide-icon>
          Hoy
        </button>
        <button 
          (click)="applyQuickFilter('week')"
          [class]="getQuickFilterClass('week')"
          class="px-3 py-1.5 text-sm border rounded-lg transition-colors hover:shadow-fioriSm">
          <lucide-icon name="calendar-range" class="w-3 h-3 mr-1"></lucide-icon>
          Esta semana
        </button>
        <button 
          (click)="applyQuickFilter('month')"
          [class]="getQuickFilterClass('month')"
          class="px-3 py-1.5 text-sm border rounded-lg transition-colors hover:shadow-fioriSm">
          <lucide-icon name="calendar" class="w-3 h-3 mr-1"></lucide-icon>
          Este mes
        </button>
        <div class="ml-auto flex items-center gap-2">
          <button 
            (click)="showFilters = !showFilters"
            class="inline-flex items-center gap-2 px-3 py-1.5 text-sm text-fiori-text hover:text-fiori-primary bg-fiori-hover hover:bg-fiori-muted rounded-lg transition-colors">
            <lucide-icon name="settings" class="w-4 h-4"></lucide-icon>
            Filtros Avanzados
          </button>
        </div>
      </div>
    </div>

    <!-- Filtros expandibles -->
    <div *ngIf="showFilters" class="p-4 fade-in">
      <form [formGroup]="filterForm" (ngSubmit)="onFilter()">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
          <div>
            <label class="block text-sm font-medium text-fiori-text mb-2">
              <lucide-icon name="calendar-days" class="w-4 h-4 mr-1 inline"></lucide-icon>
              Fecha Inicio
            </label>
            <input 
              type="date" 
              formControlName="fechaInicio"
              class="w-full px-3 py-2 text-sm border border-fiori-border rounded-lg bg-fiori-surface focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-fiori-text mb-2">
              <lucide-icon name="calendar-days" class="w-4 h-4 mr-1 inline"></lucide-icon>
              Fecha Fin
            </label>
            <input 
              type="date" 
              formControlName="fechaFin"
              class="w-full px-3 py-2 text-sm border border-fiori-border rounded-lg bg-fiori-surface focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-fiori-text mb-2">
              <lucide-icon name="search" class="w-4 h-4 mr-1 inline"></lucide-icon>
              Buscar
            </label>
            <div class="relative">
              <input 
                type="text" 
                formControlName="filter"
                (keydown.enter)="onFilter()"
                placeholder="Nombre, documento... (Presiona Enter para buscar)" 
                class="w-full pl-10 pr-3 py-2 text-sm border border-fiori-border rounded-lg bg-fiori-surface focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all">
              <lucide-icon name="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-fiori-subtext w-4 h-4"></lucide-icon>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-fiori-text mb-2">
              <lucide-icon name="building" class="w-4 h-4 mr-1 inline"></lucide-icon>
              Área
            </label>
            <div class="relative">
              <input 
                type="text" 
                id="areaFilter"
                formControlName="areaFilter"
                (input)="onAreaFilterChange($event)"
                (focus)="showAreaDropdown = true"
                (blur)="onAreaBlur()"
                placeholder="Buscar área..."
                class="w-full pl-10 pr-3 py-2 text-sm border border-fiori-border rounded-lg bg-fiori-surface focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all">
              <lucide-icon name="building" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-fiori-subtext w-4 h-4"></lucide-icon>
              
              <!-- Dropdown completo con scroll -->
              <div *ngIf="showAreaDropdown" 
                   class="absolute z-50 w-full mt-1 bg-fiori-surface border border-fiori-border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                <div 
                  (mousedown)="onAreaSelected(null)"
                  class="px-3 py-2 text-sm cursor-pointer hover:bg-fiori-hover transition-colors flex items-center gap-2 border-b border-fiori-border sticky top-0 bg-fiori-surface">
                  <lucide-icon name="globe" class="w-4 h-4 text-fiori-primary"></lucide-icon>
                  <span class="text-fiori-text font-medium">Todas las áreas</span>
                </div>
                <div *ngFor="let area of filteredAreas" 
                     (mousedown)="onAreaSelected(area)"
                     class="px-3 py-2 text-sm cursor-pointer hover:bg-fiori-hover transition-colors flex items-center gap-2">
                  <lucide-icon name="building" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
                  <span class="text-fiori-text">{{ area.descripcion }}</span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-fiori-text mb-2">
              <lucide-icon name="map-pin" class="w-4 h-4 mr-1 inline"></lucide-icon>
              Sede
            </label>
            <div class="relative">
              <input 
                type="text" 
                id="sedeFilter"
                formControlName="sedeFilter"
                (input)="onSedeFilterChange($event)"
                (focus)="showSedeDropdown = true"
                (blur)="onSedeBlur()"
                placeholder="Buscar sede..."
                class="w-full pl-10 pr-3 py-2 text-sm border border-fiori-border rounded-lg bg-fiori-surface focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all">
              <lucide-icon name="map-pin" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-fiori-subtext w-4 h-4"></lucide-icon>
              
              <!-- Dropdown con resultados filtrados -->
              <div *ngIf="showSedeDropdown" 
                   class="absolute z-50 w-full mt-1 bg-fiori-surface border border-fiori-border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                <div 
                  (mousedown)="onSedeSelected(null)"
                  class="px-3 py-2 text-sm cursor-pointer hover:bg-fiori-hover transition-colors flex items-center gap-2 border-b border-fiori-border sticky top-0 bg-fiori-surface">
                  <lucide-icon name="globe" class="w-4 h-4 text-fiori-primary"></lucide-icon>
                  <span class="text-fiori-text font-medium">Todas las sedes</span>
                </div>
                <div *ngFor="let sede of filteredSedes" 
                     (mousedown)="onSedeSelected(sede)"
                     class="px-3 py-2 text-sm cursor-pointer hover:bg-fiori-hover transition-colors flex items-center gap-2">
                  <lucide-icon name="map-pin" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
                  <span class="text-fiori-text">{{ sede.descripcion }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button 
            type="submit"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-fiori-primary text-white rounded-lg hover:bg-fiori-secondary focus:ring-2 focus:ring-fiori-primary focus:ring-offset-1 transition-colors">
            <lucide-icon name="filter" class="w-4 h-4"></lucide-icon>
            Aplicar Filtros
          </button>
          <button 
            type="button"
            (click)="filterForm.reset(); onFilter();"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-fiori-surface text-fiori-text border border-fiori-border rounded-lg hover:bg-fiori-hover transition-colors">
            <lucide-icon name="refresh-cw" class="w-4 h-4"></lucide-icon>
            Limpiar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla compacta con scroll horizontal -->
  <div class="flex-1 bg-white rounded-lg shadow-sm border overflow-hidden flex flex-col">
    

    <!-- Header con configuración de columnas usando dropdown -->
    <div class="bg-fiori-muted border-b border-fiori-border px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-sm font-semibold text-fiori-text">Registros de Asistencia Agrupados</div>
        <div class="text-xs text-fiori-subtext">{{ totalCount | number }} registros</div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Dropdown para configuración de columnas -->
        <div class="relative">
          <button 
            (click)="showColumnsConfig = !showColumnsConfig"
            (blur)="onColumnsDropdownBlur()"
            class="inline-flex items-center gap-2 px-3 py-2 text-sm text-fiori-text hover:text-fiori-primary bg-fiori-surface hover:bg-fiori-hover border border-fiori-border rounded-lg transition-colors">
            <lucide-icon name="columns" class="w-4 h-4"></lucide-icon>
            Columnas
            <lucide-icon name="chevron-down" class="w-3 h-3"></lucide-icon>
          </button>

          <!-- Dropdown content -->
          <div *ngIf="showColumnsConfig" 
               class="absolute right-0 top-full mt-1 w-80 bg-fiori-surface border border-fiori-border rounded-lg shadow-lg z-20 max-h-96 overflow-y-auto">
            
            <!-- Header del dropdown -->
            <div class="p-3 border-b border-fiori-border bg-fiori-muted rounded-t-lg">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-fiori-text">Configurar Columnas</h4>
                <div class="flex gap-1">
                  <button 
                    (click)="showAllColumns()"
                    class="px-2 py-1 text-xs bg-fiori-primary text-white rounded hover:bg-fiori-secondary transition-colors"
                    title="Mostrar todas">
                    <lucide-icon name="check-circle" class="w-3 h-3"></lucide-icon>
                  </button>
                  <button 
                    (click)="hideAllColumns()"
                    class="px-2 py-1 text-xs bg-fiori-surface text-fiori-text border border-fiori-border rounded hover:bg-fiori-hover transition-colors"
                    title="Ocultar todas">
                    <lucide-icon name="x-circle" class="w-3 h-3"></lucide-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- Grupos de columnas -->
            <div class="p-2 space-y-3">
              <!-- Información Básica -->
              <div>
                <div class="flex items-center gap-2 px-2 py-1 text-xs font-medium text-fiori-subtext uppercase">
                  <lucide-icon name="user" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                  Información Básica
                </div>
                <div class="space-y-1">
                  <label *ngFor="let col of getColumnsByGroup('basic')" 
                         class="flex items-center gap-2 px-2 py-1 text-sm cursor-pointer hover:bg-fiori-hover rounded">
                    <input 
                      type="checkbox" 
                      [(ngModel)]="col.visible"
                      class="w-4 h-4 text-fiori-primary border-fiori-border rounded focus:ring-fiori-primary focus:ring-1">
                    <span class="text-fiori-text">{{ col.label }}</span>
                  </label>
                </div>
              </div>

              <!-- Marcaciones de Entrada -->
              <div>
                <div class="flex items-center gap-2 px-2 py-1 text-xs font-medium text-fiori-subtext uppercase">
                  <lucide-icon name="log-in" class="w-3 h-3 text-green-600"></lucide-icon>
                  Marcaciones de Entrada
                </div>
                <div class="space-y-1">
                  <label *ngFor="let col of getColumnsByGroup('entrada')" 
                         class="flex items-center gap-2 px-2 py-1 text-sm cursor-pointer hover:bg-fiori-hover rounded">
                    <input 
                      type="checkbox" 
                      [(ngModel)]="col.visible"
                      class="w-4 h-4 text-fiori-primary border-fiori-border rounded focus:ring-fiori-primary focus:ring-1">
                    <span class="text-fiori-text">{{ col.label }}</span>
                  </label>
                </div>
              </div>

              <!-- Marcaciones de Salida -->
              <div>
                <div class="flex items-center gap-2 px-2 py-1 text-xs font-medium text-fiori-subtext uppercase">
                  <lucide-icon name="log-out" class="w-3 h-3 text-red-600"></lucide-icon>
                  Marcaciones de Salida
                </div>
                <div class="space-y-1">
                  <label *ngFor="let col of getColumnsByGroup('salida')" 
                         class="flex items-center gap-2 px-2 py-1 text-sm cursor-pointer hover:bg-fiori-hover rounded">
                    <input 
                      type="checkbox" 
                      [(ngModel)]="col.visible"
                      class="w-4 h-4 text-fiori-primary border-fiori-border rounded focus:ring-fiori-primary focus:ring-1">
                    <span class="text-fiori-text">{{ col.label }}</span>
                  </label>
                </div>
              </div>

              <!-- Información Adicional -->
              <div>
                <div class="flex items-center gap-2 px-2 py-1 text-xs font-medium text-fiori-subtext uppercase">
                  <lucide-icon name="info" class="w-3 h-3 text-fiori-primary"></lucide-icon>
                  Información Adicional
                </div>
                <div class="space-y-1">
                  <label *ngFor="let col of getColumnsByGroup('adicional')" 
                         class="flex items-center gap-2 px-2 py-1 text-sm cursor-pointer hover:bg-fiori-hover rounded">
                    <input 
                      type="checkbox" 
                      [(ngModel)]="col.visible"
                      class="w-4 h-4 text-fiori-primary border-fiori-border rounded focus:ring-fiori-primary focus:ring-1">
                    <span class="text-fiori-text">{{ col.label }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="flex-1 flex items-center justify-center">
      <div class="flex items-center gap-2">
        <mat-spinner diameter="20"></mat-spinner>
        <span class="text-gray-500 text-sm">Cargando datos...</span>
      </div>
    </div>

    <!-- Empty state -->
    <div *ngIf="!loading && groupedDataSource.data.length === 0" class="flex-1 flex items-center justify-center">
      <div class="flex flex-col items-center gap-2">
        <mat-icon class="text-gray-300 text-4xl">description</mat-icon>
        <span class="text-gray-500 text-sm">No hay datos para mostrar</span>
        <button 
          (click)="filterForm.reset(); getData();"
          class="text-xs text-blue-600 hover:text-blue-800 mt-2">
          Limpiar filtros
        </button>
      </div>
    </div>

    <!-- Tabla con scroll horizontal y vertical -->
    <div *ngIf="!loading && groupedDataSource.data.length > 0" class="flex-1 overflow-auto">
      <table class="w-full text-xs divide-y divide-gray-200" style="min-width: 2000px;">
        <!-- Header sticky -->
        <thead class="bg-gray-50 sticky top-0 z-10">
          <tr>
            <!-- Empleado -->
            <th *ngIf="isColumnVisible('fullNameEmployee')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 sticky left-0 bg-gray-50" 
                style="min-width: 180px; z-index: 30 !important;">
              <div class="flex items-center gap-1">
                <span>Empleado</span>
                <button (click)="onSort('fullNameEmployee')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('fullNameEmployee') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Documento -->
            <th *ngIf="isColumnVisible('nroDoc')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              <div class="flex items-center gap-1">
                <span>Doc</span>
                <button (click)="onSort('nroDoc')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('nroDoc') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Área -->
            <th *ngIf="isColumnVisible('areaDescription')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              <div class="flex items-center gap-1">
                <span>Área</span>
                <button (click)="onSort('areaDescription')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('areaDescription') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Sede -->
            <th *ngIf="isColumnVisible('locationName')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              <div class="flex items-center gap-1">
                <span>Sede</span>
                <button (click)="onSort('locationName')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('locationName') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Fecha -->
            <th *ngIf="isColumnVisible('fechaFormateada')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 90px;">
              <div class="flex items-center gap-1">
                <span>Fecha</span>
                <button (click)="onSort('fechaFormateada')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('fechaFormateada') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Turno -->
            <th *ngIf="isColumnVisible('shiftName')" 
                class="px-2 py-2 text-left font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              <div class="flex items-center gap-1">
                <span>Turno</span>
                <button (click)="onSort('shiftName')" class="ml-1">
                  <mat-icon class="text-xs">{{ getSortIcon('shiftName') }}</mat-icon>
                </button>
              </div>
            </th>

            <!-- Entrada - Horario -->
            <th *ngIf="isColumnVisible('intervalAlias')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              Entrada Horario
            </th>

            <!-- Entrada - Esperado -->
            <th *ngIf="isColumnVisible('horaEsperada')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Entrada Esperado
            </th>

            <!-- Entrada - Real -->
            <th *ngIf="isColumnVisible('horaMarcacionReal')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Entrada Real
            </th>

            <!-- Entrada - Estado -->
            <th *ngIf="isColumnVisible('estadoMarcacion')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 90px;">
              Entrada Estado
            </th>

            <!-- Entrada - Tardanza -->
            <th *ngIf="isColumnVisible('minutosTardanza')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Tardanza (min)
            </th>

            <!-- Salida - Horario -->
            <th *ngIf="isColumnVisible('intervalAlias')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              Salida Horario
            </th>

            <!-- Salida - Esperado -->
            <th *ngIf="isColumnVisible('horaEsperada')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Salida Esperado
            </th>

            <!-- Salida - Real -->
            <th *ngIf="isColumnVisible('horaMarcacionReal')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Salida Real
            </th>

            <!-- Salida - Estado -->
            <th *ngIf="isColumnVisible('estadoMarcacion')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 90px;">
              Salida Estado
            </th>

            <!-- Salida - Adelanto -->
            <th *ngIf="isColumnVisible('minutosAdelanto')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 80px;">
              Adelanto (min)
            </th>

            <!-- Tipo Horario -->
            <th *ngIf="isColumnVisible('tipoMarcacion')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              Tipo Horario
            </th>

            <!-- Observaciones -->
            <th *ngIf="isColumnVisible('exceptionRemarks')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 150px;">
              Observaciones
            </th>

            <!-- Tipo Permiso -->
            <th *ngIf="isColumnVisible('tipoPermiso')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              Tipo Permiso
            </th>

            <!-- Días Info -->
            <th *ngIf="isColumnVisible('diasInfo')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              Días Info
            </th>

            <!-- Razón Manual -->
            <th *ngIf="isColumnVisible('razonManual')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              Razón Manual
            </th>

            <!-- Validación Rango -->
            <th *ngIf="isColumnVisible('validacionRango')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 120px;">
              Validación
            </th>

            <!-- Información Adicional -->
            <th *ngIf="isColumnVisible('informacionAdicional')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 150px;">
              Info Adicional
            </th>

            <!-- Origen -->
            <th *ngIf="isColumnVisible('origenMarcacion')" 
                class="px-2 py-2 text-center font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200" 
                style="min-width: 100px;">
              Origen
            </th>

          </tr>
        </thead>
        
        <!-- Body -->
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let record of groupedDataSource.data; trackBy: trackByGroupedRecord" 
              [class]="getGroupedRowClass(record) + ' transition-colors'"
              (contextmenu)="onRightClick($event, record)"
              class="cursor-pointer hover:bg-fiori-hover">
            
            <!-- Empleado -->
            <td *ngIf="isColumnVisible('fullNameEmployee')" 
                [class]="'px-2 py-1 border-r border-gray-200 sticky left-0 ' + getGroupedRowClass(record)"
                style="z-index: 0 !important;">
              <div class="text-xs font-medium text-gray-900 truncate">{{ record.fullNameEmployee }}</div>
            </td>

            <!-- Documento -->
            <td *ngIf="isColumnVisible('nroDoc')" class="px-2 py-1 border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.nroDoc }}</div>
            </td>

            <!-- Área -->
            <td *ngIf="isColumnVisible('areaDescription')" class="px-2 py-1 border-r border-gray-200">
              <div class="text-xs text-gray-900 truncate">{{ record.areaDescription }}</div>
            </td>

            <!-- Sede -->
            <td *ngIf="isColumnVisible('locationName')" class="px-2 py-1 border-r border-gray-200">
              <div class="text-xs text-gray-900 truncate">{{ record.locationName }}</div>
            </td>

            <!-- Fecha -->
            <td *ngIf="isColumnVisible('fechaFormateada')" class="px-2 py-1 border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.fechaFormateada }}</div>
            </td>

            <!-- Turno -->
            <td *ngIf="isColumnVisible('shiftName')" class="px-2 py-1 border-r border-gray-200">
              <div class="text-xs text-gray-900 truncate">{{ record.shiftName }}</div>
            </td>

            <!-- Entrada - Horario -->
            <td *ngIf="isColumnVisible('intervalAlias')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">
                {{ record.marcaciones.entrada?.intervalAlias || '-' }}
              </div>
            </td>

            <!-- Entrada - Esperado -->
            <td *ngIf="isColumnVisible('horaEsperada')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">
                {{ record.marcaciones.entrada?.horaEsperada || '-' }}
              </div>
            </td>

            <!-- Entrada - Real -->
            <td *ngIf="isColumnVisible('horaMarcacionReal')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs font-medium text-gray-900">
                {{ record.marcaciones.entrada?.horaMarcacionReal || 'Sin marcar' }}
              </div>
            </td>

            <!-- Entrada - Estado -->
            <td *ngIf="isColumnVisible('estadoMarcacion')" class="px-2 py-1 text-center border-r border-gray-200">
              <span *ngIf="record.marcaciones.entrada" 
                    [class]="getEstadoBadgeClass(record.marcaciones.entrada.estadoMarcacion)"
                    class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium">
                {{ record.marcaciones.entrada.estadoMarcacion }}
              </span>
              <span *ngIf="!record.marcaciones.entrada" class="text-xs text-gray-400">-</span>
            </td>

            <!-- Entrada - Tardanza -->
            <td *ngIf="isColumnVisible('minutosTardanza')" class="px-2 py-1 text-center border-r border-gray-200">
              <div *ngIf="record.marcaciones.entrada && record.marcaciones.entrada.minutosTardanza > 0" 
                   class="text-xs text-red-600 font-medium">
                +{{ record.marcaciones.entrada.minutosTardanza }}
              </div>
              <div *ngIf="!record.marcaciones.entrada || record.marcaciones.entrada.minutosTardanza <= 0" 
                   class="text-xs text-gray-400">-</div>
            </td>

            <!-- Salida - Horario -->
            <td *ngIf="isColumnVisible('intervalAlias')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">
                {{ record.marcaciones.salida?.intervalAlias || '-' }}
              </div>
            </td>

            <!-- Salida - Esperado -->
            <td *ngIf="isColumnVisible('horaEsperada')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">
                {{ record.marcaciones.salida?.horaEsperada || '-' }}
              </div>
            </td>

            <!-- Salida - Real -->
            <td *ngIf="isColumnVisible('horaMarcacionReal')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs font-medium text-gray-900">
                {{ record.marcaciones.salida?.horaMarcacionReal || 'Sin marcar' }}
              </div>
            </td>

            <!-- Salida - Estado -->
            <td *ngIf="isColumnVisible('estadoMarcacion')" class="px-2 py-1 text-center border-r border-gray-200">
              <span *ngIf="record.marcaciones.salida" 
                    [class]="getEstadoBadgeClass(record.marcaciones.salida.estadoMarcacion)"
                    class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium">
                {{ record.marcaciones.salida.estadoMarcacion }}
              </span>
              <span *ngIf="!record.marcaciones.salida" class="text-xs text-gray-400">-</span>
            </td>

            <!-- Salida - Adelanto -->
            <td *ngIf="isColumnVisible('minutosAdelanto')" class="px-2 py-1 text-center border-r border-gray-200">
              <div *ngIf="record.marcaciones.salida && record.marcaciones.salida.minutosAdelanto > 0" 
                   class="text-xs text-green-600 font-medium">
                -{{ record.marcaciones.salida.minutosAdelanto }}
              </div>
              <div *ngIf="!record.marcaciones.salida || record.marcaciones.salida.minutosAdelanto <= 0" 
                   class="text-xs text-gray-400">-</div>
            </td>

            <!-- Tipo Horario -->
            <td *ngIf="isColumnVisible('tipoMarcacion')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.tipoHorario || '-' }}</div>
            </td>

            <!-- Observaciones (exceptionRemarks) -->
            <td *ngIf="isColumnVisible('exceptionRemarks')" class="px-2 py-1 text-center border-r border-gray-200">
              <div *ngIf="record.exceptionRemarks" class="text-xs text-orange-700 bg-orange-100 px-2 py-1 rounded">
                {{ record.exceptionRemarks }}
              </div>
              <div *ngIf="!record.exceptionRemarks" class="text-xs text-gray-400">-</div>
            </td>

            <!-- Tipo Permiso -->
            <td *ngIf="isColumnVisible('tipoPermiso')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.tipoPermiso || '-' }}</div>
            </td>

            <!-- Días Info -->
            <td *ngIf="isColumnVisible('diasInfo')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.diasInfo || '-' }}</div>
            </td>

            <!-- Razón Manual -->
            <td *ngIf="isColumnVisible('razonManual')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.razonManual || '-' }}</div>
            </td>

            <!-- Validación Rango -->
            <td *ngIf="isColumnVisible('validacionRango')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">{{ record.validacionRango || '-' }}</div>
            </td>

            <!-- Información Adicional -->
            <td *ngIf="isColumnVisible('informacionAdicional')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900 truncate">
                {{ (record.marcaciones.entrada?.informacionAdicional || record.marcaciones.salida?.informacionAdicional) || '-' }}
              </div>
            </td>

            <!-- Origen -->
            <td *ngIf="isColumnVisible('origenMarcacion')" class="px-2 py-1 text-center border-r border-gray-200">
              <div class="text-xs text-gray-900">
                {{ (record.marcaciones.entrada?.origenMarcacion || record.marcaciones.salida?.origenMarcacion) || '-' }}
              </div>
            </td>

          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginador Fiori Genérico -->
  <app-fiori-paginator
    [totalRecords]="totalCount"
    [pageSize]="pageSize"
    [pageNumber]="page"
    [loading]="loading"
    [pageSizeOptions]="[10, 20, 50, 100, 200]"
    [showAllOption]="true"
    (pageChange)="onPaginatorChange($event)">
  </app-fiori-paginator>

  <!-- Menú Contextual Flotante -->
  <div *ngIf="showContextMenu" 
       class="fixed bg-white border border-gray-300 rounded-lg shadow-xl z-50 min-w-64 py-2"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       (click)="closeContextMenu()"
       (mouseleave)="closeContextMenu()">
    
    <!-- Header del menú con información del empleado -->
    <div class="px-4 py-3 border-b border-gray-200 bg-fiori-muted">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-fiori-primary/10 rounded-full flex items-center justify-center">
          <lucide-icon name="user" class="w-4 h-4 text-fiori-primary"></lucide-icon>
        </div>
        <div>
          <div class="font-medium text-sm text-fiori-text">{{ selectedRecord?.fullNameEmployee }}</div>
          <div class="text-xs text-fiori-subtext">{{ selectedRecord?.fechaFormateada }} • {{ selectedRecord?.areaDescription }}</div>
        </div>
      </div>
    </div>

    <!-- Opciones del menú -->
    <div class="py-1">
      
      <!-- Registrar Marcación Completa (cuando faltan ambas) -->
      <button *ngIf="canRegisterCompleteAttendance(selectedRecord)"
              (click)="registerCompleteAttendance(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="plus-circle" class="w-4 h-4 text-blue-600"></lucide-icon>
        <div>
          <div class="font-medium">Registrar Marcación</div>
          <div class="text-xs text-gray-500">Agregar entrada y/o salida faltante</div>
        </div>
      </button>

      <!-- Registrar Marcación de Entrada (cuando solo falta entrada) -->
      <button *ngIf="canRegisterOnlyEntrada(selectedRecord)"
              (click)="registerEntradaManual(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="log-in" class="w-4 h-4 text-green-600"></lucide-icon>
        <div>
          <div class="font-medium">Registrar Marcación de Entrada</div>
          <div class="text-xs text-gray-500">Agregar marcación de entrada faltante</div>
        </div>
      </button>

      <!-- Registrar Marcación de Salida (cuando solo falta salida) -->
      <button *ngIf="canRegisterOnlySalida(selectedRecord)"
              (click)="registerSalidaManual(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="log-out" class="w-4 h-4 text-red-600"></lucide-icon>
        <div>
          <div class="font-medium">Registrar Marcación de Salida</div>
          <div class="text-xs text-gray-500">Agregar marcación de salida faltante</div>
        </div>
      </button>

      <!-- Separador -->
      <div class="border-t border-gray-200 my-1"></div>

      <!-- Ver Detalles Completos -->
      <button (click)="viewFullDetails(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="eye" class="w-4 h-4 text-fiori-primary"></lucide-icon>
        <div>
          <div class="font-medium">Ver Detalles Completos</div>
          <div class="text-xs text-gray-500">Información detallada de marcaciones</div>
        </div>
      </button>

      <!-- Justificar Tardanza -->
      <button *ngIf="selectedRecord?.esTardanza"
              (click)="justifyLateness(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="clock" class="w-4 h-4 text-orange-600"></lucide-icon>
        <div>
          <div class="font-medium">Justificar Tardanza</div>
          <div class="text-xs text-gray-500">Agregar justificación de tardanza</div>
        </div>
      </button>

      <!-- Separador -->
      <div class="border-t border-gray-200 my-1"></div>

      <!-- Exportar Fila -->
      <button (click)="exportSingleRow(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="download" class="w-4 h-4 text-green-600"></lucide-icon>
        <div>
          <div class="font-medium">Exportar a Excel</div>
          <div class="text-xs text-gray-500">Descargar solo esta marcación</div>
        </div>
      </button>

      <!-- Reportar Inconsistencia -->
      <button (click)="reportInconsistency(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="alert-triangle" class="w-4 h-4 text-red-600"></lucide-icon>
        <div>
          <div class="font-medium">Reportar Inconsistencia</div>
          <div class="text-xs text-gray-500">Marcar problema en la marcación</div>
        </div>
      </button>

      <!-- Copiar Información -->
      <button (click)="copyInformation(selectedRecord)"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-fiori-hover transition-colors">
        <lucide-icon name="copy" class="w-4 h-4 text-gray-600"></lucide-icon>
        <div>
          <div class="font-medium">Copiar Información</div>
          <div class="text-xs text-gray-500">Copiar datos al portapapeles</div>
        </div>
      </button>

    </div>
  </div>

  <!-- Overlay para cerrar menú al hacer click fuera -->
  <div *ngIf="showContextMenu" 
       class="fixed inset-0 z-40" 
       (click)="closeContextMenu()">
  </div>

</div>