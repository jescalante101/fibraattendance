<div class="p-4 max-w-full">
  <!-- Header compacto -->
  <div class="mb-4 flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border">
    <div class="flex items-center gap-2">
      <div class="w-1 h-6 bg-blue-600 rounded-full"></div>
      <span class="text-gray-900 font-semibold text-lg">Análisis de Marcaciones</span>
      <div class="ml-4 flex items-center gap-1 text-sm text-gray-500">
        <mat-icon class="text-base">dataset</mat-icon>
        <span>{{ totalCount }}</span> registros
      </div>
    </div>
    <div class="flex gap-2">
      <button 
        (click)="exportToExcel()" 
        class="inline-flex items-center gap-1 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-md hover:bg-green-100 transition-colors">
        <mat-icon class="text-sm">download</mat-icon>
        Excel
      </button>
      <button 
        (click)="exportToPDF()" 
        class="inline-flex items-center gap-1 px-3 py-1.5 text-sm bg-red-50 text-red-700 border border-red-200 rounded-md hover:bg-red-100 transition-colors">
        <mat-icon class="text-sm">picture_as_pdf</mat-icon>
        PDF
      </button>
    </div>
  </div>

  <!-- Filtros compactos en tarjeta -->
  <div class="mb-4 bg-white rounded-lg shadow-sm border">
    <!-- Quick filters -->
    <div class="px-4 pt-3 pb-2 border-b border-gray-100">
      <div class="flex flex-wrap gap-2">
        <button 
          (click)="applyQuickFilter('today')"
          [class]="getQuickFilterClass('today')"
          class="px-3 py-1 text-xs border rounded-md transition-colors">
          Hoy
        </button>
        <button 
          (click)="applyQuickFilter('week')"
          [class]="getQuickFilterClass('week')"
          class="px-3 py-1 text-xs border rounded-md transition-colors">
          Esta semana
        </button>
        <button 
          (click)="applyQuickFilter('month')"
          [class]="getQuickFilterClass('month')"
          class="px-3 py-1 text-xs border rounded-md transition-colors">
          Este mes
        </button>
        <div class="ml-auto flex items-center gap-2">
          <button 
            (click)="showFilters = !showFilters; showColumnsConfig = false"
            class="inline-flex items-center gap-1 px-2 py-1 text-xs text-gray-600 hover:text-blue-600 transition-colors">
            <mat-icon class="text-sm">tune</mat-icon>
            Filtros
          </button>
          <button 
            (click)="showColumnsConfig = !showColumnsConfig; showFilters = false"
            class="inline-flex items-center gap-1 px-2 py-1 text-xs text-gray-600 hover:text-blue-600 transition-colors">
            <mat-icon class="text-sm">view_column</mat-icon>
            Columnas
          </button>
        </div>
      </div>
    </div>

    <!-- Filtros expandibles -->
    <div *ngIf="showFilters" class="p-4 fade-in">
      <form [formGroup]="filterForm" (ngSubmit)="onFilter()">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Inicio</label>
            <input 
              type="date" 
              formControlName="fechaInicio"
              class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Fin</label>
            <input 
              type="date" 
              formControlName="fechaFin"
              class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Buscar</label>
            <div class="relative">
              <input 
                type="text" 
                formControlName="filter"
                placeholder="Nombre, documento..." 
                class="w-full pl-7 pr-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              <mat-icon class="absolute left-2 top-1.5 text-gray-400 text-sm">search</mat-icon>
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área</label>
            <select 
              formControlName="areaId"
              class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white">
              <option value="">Todas las áreas</option>
              <option *ngFor="let area of areas" [value]="area.areaId">{{ area.descripcion }}</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Sede</label>
            <select 
              formControlName="locationId"
              class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white">
              <option value="">Todas las sedes</option>
              <option *ngFor="let sede of sedes" [value]="sede.categoriaAuxiliarId">{{ sede.descripcion }}</option>
            </select>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button 
            type="submit"
            class="inline-flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            <mat-icon class="text-sm">filter_list</mat-icon>
            Aplicar
          </button>
          <button 
            type="button"
            (click)="filterForm.reset(); onFilter();"
            class="inline-flex items-center gap-1 px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
            <mat-icon class="text-sm">refresh</mat-icon>
            Limpiar
          </button>
        </div>
      </form>
    </div>

    <!-- Panel de columnas -->
    <div *ngIf="showColumnsConfig" class="p-4 border-t border-gray-100 fade-in">
      <div class="flex items-center justify-between mb-3">
        <span class="text-sm font-medium text-gray-700">Configurar Columnas</span>
        <div class="flex gap-2">
          <button 
            (click)="showAllColumns()"
            class="text-xs text-blue-600 hover:text-blue-800">Mostrar todas</button>
          <button 
            (click)="hideAllColumns()"
            class="text-xs text-gray-500 hover:text-gray-700">Ocultar todas</button>
        </div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
        <label 
          *ngFor="let col of columns" 
          class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
          <input 
            type="checkbox" 
            [(ngModel)]="col.visible"
            class="rounded text-blue-600">
          <span class="truncate">{{ col.label }}</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Estadísticas + Header sticky como una unidad -->
  <div class="sticky top-0 z-30 bg-gray-50 border-b border-gray-200">
    <!-- Estadísticas compactas -->
    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 py-3 px-4" id="statsSection">
      <div 
        (click)="applyQuickStatsFilter(null)"
        [class]="getStatsCardClass(null)"
        class="bg-white border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-gray-900">{{ quickStats.total }}</div>
        <div class="text-xs text-gray-500">Total</div>
      </div>
      <div 
        (click)="applyQuickStatsFilter('puntuales')"
        [class]="getStatsCardClass('puntuales')"
        class="bg-green-50 border border-green-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-green-700">{{ quickStats.puntuales }}</div>
        <div class="text-xs text-green-600">Puntuales</div>
      </div>
      <div 
        (click)="applyQuickStatsFilter('tardanzas')"
        [class]="getStatsCardClass('tardanzas')"
        class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-orange-700">{{ quickStats.tardanzas }}</div>
        <div class="text-xs text-orange-600">Tardanzas</div>
      </div>
      <div 
        (click)="applyQuickStatsFilter('faltas')"
        [class]="getStatsCardClass('faltas')"
        class="bg-red-50 border border-red-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-red-700">{{ quickStats.faltas }}</div>
        <div class="text-xs text-red-600">Faltas</div>
      </div>
      <div 
        (click)="applyQuickStatsFilter('manuales')"
        [class]="getStatsCardClass('manuales')"
        class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-yellow-700">{{ quickStats.manuales }}</div>
        <div class="text-xs text-yellow-600">Manuales</div>
      </div>
      <div 
        (click)="applyQuickStatsFilter('noLaborable')"
        [class]="getStatsCardClass('noLaborable')"
        class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-all">
        <div class="text-lg font-bold text-gray-700">{{ quickStats.noLaborable }}</div>
        <div class="text-xs text-gray-600">No Laborable</div>
      </div>
    </div>

    <!-- Header de tabla como parte del sticky -->
    <div class="bg-white border-t border-gray-200">
      <div class="overflow-x-auto" id="tableHeaderContainer">
        <table class="min-w-full">
          <thead>
            <tr class="bg-gray-50">
              <!-- Columna Empleado (Sticky horizontal) -->
              <th *ngIf="isColumnVisible('fullNameEmployee')" 
                  class="sticky left-0 bg-gray-50 z-40 border-r border-gray-300 px-3 py-2 text-left">
                <div class="flex items-center gap-2">
                  <input 
                    type="checkbox" 
                    [checked]="selectAllChecked"
                    [indeterminate]="isIndeterminate()"
                    (change)="toggleSelectAll()"
                    class="rounded text-blue-600">
                  <span class="text-xs font-medium text-gray-700">Empleado</span>
                  <button (click)="onSort('fullNameEmployee')" class="text-gray-400 hover:text-gray-600">
                    <mat-icon class="text-sm">{{ getSortIcon('fullNameEmployee') }}</mat-icon>
                  </button>
                </div>
              </th>

              <!-- Resto de columnas dinámicas -->
              <th *ngFor="let col of visibleColumnsFiltered()" class="px-3 py-2 text-left bg-gray-50">
                <div class="flex items-center gap-1">
                  <span class="text-xs font-medium text-gray-700">{{ col.label }}</span>
                  <button (click)="onSort(col.id)" class="text-gray-400 hover:text-gray-600">
                    <mat-icon class="text-sm">{{ getSortIcon(col.id) }}</mat-icon>
                  </button>
                </div>
              </th>

              <!-- Columna de Acciones -->
              <th *ngIf="isColumnVisible('actions')" 
                  class="px-3 py-2 text-center bg-gray-50">
                <span class="text-xs font-medium text-gray-700">Acciones</span>
              </th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  <!-- Filtro activo indicator -->
  <div *ngIf="quickFilter !== null" class="mb-4 flex items-center gap-2">
    <button 
      (click)="clearQuickStatsFilter()" 
      class="px-3 py-1 rounded bg-blue-100 text-blue-800 hover:bg-blue-200 transition text-xs">
      Limpiar filtro de estadística
    </button>
    <span class="text-xs text-gray-500">Mostrando solo: <strong>{{ getQuickFilterLabel(quickFilter) }}</strong></span>
  </div>

  <!-- Acciones masivas -->
  <div *ngIf="selectedRows.size > 0" class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3 fade-in">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <mat-icon class="text-blue-600 text-lg">check_circle</mat-icon>
        <span class="text-sm font-medium text-blue-900">
          {{ selectedRows.size }} elemento{{ selectedRows.size > 1 ? 's' : '' }} seleccionado{{ selectedRows.size > 1 ? 's' : '' }}
        </span>
      </div>
      <div class="flex gap-2">
        <button 
          (click)="exportSelectedToExcel()"
          class="inline-flex items-center gap-1 px-3 py-1.5 text-sm bg-white text-blue-700 border border-blue-200 rounded-md hover:bg-blue-50 transition-colors">
          <mat-icon class="text-sm">download</mat-icon>
          Exportar
        </button>
        <button 
          (click)="clearSelection()"
          class="text-sm text-blue-600 hover:text-blue-800 px-2">Limpiar selección</button>
      </div>
    </div>
  </div>

  <!-- Body de la tabla separado -->
  <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
    <div class="overflow-x-auto" id="tableContainer">
      <table class="min-w-full">
        <!-- Solo el body de la tabla -->
        <tbody class="divide-y divide-gray-100">
          <!-- Loading state -->
          <tr *ngIf="loading">
            <td [attr.colspan]="displayedColumns.length" class="text-center py-8">
              <div class="flex items-center justify-center gap-2">
                <mat-spinner diameter="20"></mat-spinner>
                <span class="text-gray-500 text-sm">Cargando datos...</span>
              </div>
            </td>
          </tr>

          <!-- Empty state -->
          <tr *ngIf="!loading && dataSource.data.length === 0">
            <td [attr.colspan]="displayedColumns.length" class="text-center py-8">
              <div class="flex flex-col items-center gap-2">
                <mat-icon class="text-gray-300 text-4xl">description</mat-icon>
                <span class="text-gray-500 text-sm">No hay datos para mostrar</span>
                <button 
                  *ngIf="hasFilters()"
                  (click)="clearAllFilters()"
                  class="text-xs text-blue-600 hover:text-blue-800 mt-2">
                  Limpiar filtros
                </button>
              </div>
            </td>
          </tr>

          <!-- Filas de datos -->
          <tr *ngFor="let item of dataSource.data; trackBy: trackByFn" 
              [ngClass]="getRowClass(item)"
              class="transition-colors duration-200 hover:bg-gray-50">
            
            <!-- Columna Empleado (Sticky horizontal) -->
            <td *ngIf="isColumnVisible('fullNameEmployee')" 
                class="sticky left-0 bg-white z-10 border-r border-gray-200 px-3 py-2"
                [ngClass]="getRowClass(item)">
              <div class="flex items-center gap-2">
                <input 
                  type="checkbox" 
                  [checked]="isRowSelected(item)"
                  (change)="toggleRowSelection(item)"
                  class="rounded text-blue-600">
                <div>
                  <div class="text-sm font-medium text-gray-900">{{ getColumnValue(item, 'fullNameEmployee') }}</div>
                  <div class="text-xs text-gray-500">{{ item.areaDescription }}</div>
                </div>
              </div>
            </td>

            <!-- Resto de columnas dinámicas -->
            <td *ngFor="let col of visibleColumnsFiltered()" class="px-3 py-2 text-sm text-gray-700">
              
              <!-- Fecha formateada -->
              <ng-container *ngIf="col.id === 'fechaFormateada'">
                <span *ngIf="getColumnValue(item, 'fechaFormateada'); else formatFecha">
                  {{ getColumnValue(item, 'fechaFormateada') }}
                </span>
                <ng-template #formatFecha>
                  {{ getColumnValue(item, 'fecha') | date:'dd-MM-yyyy' }}
                </ng-template>
              </ng-container>
              
              <!-- Campos booleanos con badges -->
              <ng-container *ngIf="col.id !== 'fechaFormateada'">
                <span *ngIf="col.id === 'esFalta' || col.id === 'esMarcacionManual' || col.id === 'esTardanza' || col.id === 'esPuntual'" 
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      [ngClass]="getBadgeClass(col.id, getColumnValue(item, col.id))">
                  {{ getColumnValue(item, col.id) ? 'Sí' : 'No' }}
                </span>
                
                <!-- Estado con badge especial -->
                <span *ngIf="col.id === 'estadoMarcacion'" 
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      [ngClass]="getEstadoBadgeClass(getColumnValue(item, col.id))">
                  {{ getColumnValue(item, col.id) }}
                </span>
                
                <!-- Horas formateadas -->
                <span *ngIf="col.id === 'horaEsperada' || col.id === 'horaMarcacionReal'">
                  {{ formatTime(getColumnValue(item, col.id)) }}
                </span>
                
                <!-- Diferencia en minutos -->
                <span *ngIf="col.id === 'diferenciaMinutos' || col.id === 'minutosTardanza' || col.id === 'minutosAdelanto'">
                  {{ formatMinutes(getColumnValue(item, col.id)) }}
                </span>
                
                <!-- Otros campos -->
                <span *ngIf="!['esFalta', 'esMarcacionManual', 'esTardanza', 'esPuntual', 'estadoMarcacion', 'horaEsperada', 'horaMarcacionReal', 'diferenciaMinutos', 'minutosTardanza', 'minutosAdelanto'].includes(col.id)">
                  {{ getColumnValue(item, col.id) || '-' }}
                </span>
              </ng-container>
            </td>

            <!-- Columna de Acciones -->
            <td *ngIf="isColumnVisible('actions')" class="px-3 py-2 text-center">
              <div class="flex justify-center gap-1">
                <button 
                  (click)="viewDetails(item)"
                  class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors" 
                  title="Ver detalles">
                  <mat-icon class="text-sm">visibility</mat-icon>
                </button>
                <button 
                  (click)="editItem(item)"
                  class="p-1 text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded transition-colors" 
                  title="Editar">
                  <mat-icon class="text-sm">edit</mat-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginador compacto -->
  <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-3 bg-white p-3 rounded-lg shadow-sm border">
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <span>Mostrar</span>
      <select 
        [(ngModel)]="pageSize" 
        (change)="onPageSizeChange()" 
        class="px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
      <span>de {{ totalCount | number }} resultados</span>
    </div>
    
    <div class="flex items-center gap-1">
      <span class="text-sm text-gray-600 mr-4">
        {{ getPageStart() }} - {{ getPageEnd() }} de {{ totalCount | number }}
      </span>
      
      <button 
        (click)="onPageChange(1)" 
        [disabled]="page === 1"
        class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        title="Primera página">
        <mat-icon class="text-sm">first_page</mat-icon>
      </button>
      
      <button 
        (click)="onPageChange(page - 1)" 
        [disabled]="page === 1"
        class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        title="Página anterior">
        <mat-icon class="text-sm">chevron_left</mat-icon>
      </button>
      
      <div class="flex gap-1">
        <button 
          *ngFor="let pageNum of getVisiblePages()"
          (click)="onPageChange(pageNum)"
          [class]="pageNum === page ? 'px-2 py-1.5 text-sm bg-blue-600 text-white rounded border border-blue-600' : 'px-2 py-1.5 text-sm border border-gray-300 hover:bg-gray-50 rounded transition-colors'"
          [disabled]="pageNum === '...'"
          class="min-w-[32px]">
          {{ pageNum }}
        </button>
      </div>
      
      <button 
        (click)="onPageChange(page + 1)" 
        [disabled]="page >= totalPages"
        class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        title="Página siguiente">
        <mat-icon class="text-sm">chevron_right</mat-icon>
      </button>
      
      <button 
        (click)="onPageChange(totalPages)" 
        [disabled]="page >= totalPages"
        class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        title="Última página">
        <mat-icon class="text-sm">last_page</mat-icon>
      </button>
    </div>
  </div>
</div>