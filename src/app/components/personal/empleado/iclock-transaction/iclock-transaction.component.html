<div class="mx-auto max-w-7xl p-4 lg:p-6">
  <!-- Barra de ventana tipo Windows para el diálogo completo -->
  <div class="flex items-center justify-between px-3 py-1 bg-fiori-muted rounded-t-xl border border-fiori-border mb-4">
    <div class="flex items-center gap-2 select-none">
      <mat-icon class="text-fiori-primary text-lg">schedule</mat-icon>
      <span class="text-base font-semibold text-fiori-text">Marcaciones de Tiempo</span>
    </div>
    <button mat-icon-button (click)="cerrar()" matTooltip="Cerrar ventana"
      class="hover:bg-red-100 hover:text-red-600 transition-colors rounded-full">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <!-- CABECERA MEJORADA SIN h1/h2 -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>

        <div class="flex items-center gap-2 text-fiori-subtext mt-1">
          <mat-icon class="text-base">person</mat-icon>
          <span class="font-medium">{{ data?.empleado?.nombres }} {{ data?.empleado?.apellidoPaterno }}</span>
        </div>
      </div>
      <!-- Estadísticas rápidas -->
      <div class="flex gap-4 mt-4 md:mt-0">
        <div class="bg-fiori-surface rounded-lg p-3 shadow-fiori border border-fiori-border min-w-[120px]">
          <div class="text-xs text-fiori-subtext uppercase">Total Marcaciones</div>
          <div class="text-xl font-bold text-fiori-text">{{ marcaciones.length || 0 }}</div>
        </div>
        <div class="bg-fiori-surface rounded-lg p-3 shadow-fiori border border-fiori-border min-w-[120px]">
          <div class="text-xs text-fiori-subtext uppercase">Período</div>
          <div class="text-base font-semibold text-fiori-text">
            {{ fechaInicio && fechaFin ? getDiasRango() + ' días' : 'Mes actual' }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS MEJORADOS SOLO CONTENIDO -->
  <div class="bg-fiori-surface rounded-xl shadow-fiori border border-fiori-border mb-4">
    <div class="p-2">
      <form class="flex flex-col md:flex-row md:items-end gap-2 md:gap-3" (ngSubmit)="buscarMarcaciones()">
        <mat-form-field class="w-full md:w-44" appearance="fill">
          <mat-label>Fecha inicio</mat-label>
          <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" name="fechaInicio" required>
          <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
          <mat-datepicker #pickerInicio></mat-datepicker>
        </mat-form-field>
        <mat-form-field class="w-full md:w-44" appearance="fill">
          <mat-label>Fecha fin</mat-label>
          <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" name="fechaFin" required>
          <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
          <mat-datepicker #pickerFin></mat-datepicker>
        </mat-form-field>
        <button mat-raised-button color="primary" type="submit" class="h-9 min-w-[36px] px-2 flex items-center gap-1">
          <mat-icon class="text-base">search</mat-icon>
          <span class="hidden md:inline">Buscar</span>
        </button>
        <button mat-stroked-button type="button" (click)="limpiarFiltros()" class="h-9 min-w-[36px] px-2 flex items-center gap-1" matTooltip="Limpiar filtros">
          <mat-icon class="text-base">refresh</mat-icon>
          <span class="hidden md:inline">Limpiar</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Acciones rápidas -->
  <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-2 text-fiori-subtext">
      <mat-icon class="text-base">schedule</mat-icon>
      <span>Mostrando {{ marcaciones.length || 0 }} marcaciones</span>
    </div>
    
    <div class="flex gap-2">
      <button mat-stroked-button (click)="exportarExcel()" class="flex items-center gap-2">
        <mat-icon>file_download</mat-icon>
        Exportar Excel
      </button>
      <button mat-stroked-button (click)="exportarPDF()" class="flex items-center gap-2">
        <mat-icon>picture_as_pdf</mat-icon>
        Exportar PDF
      </button>
    </div>
  </div>

  <!-- Contenedor de tabla con mejor diseño y scroll vertical -->
  <div class="bg-fiori-surface rounded-xl shadow-fiori border border-fiori-border overflow-hidden">
    <div class="overflow-x-auto" style="max-height: 500px; overflow-y: auto;">
      <table mat-table [dataSource]="marcaciones" class="w-full">
        <!-- ID -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4 sticky top-0 z-10">
            ID
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4 text-fiori-text">
            <span class="font-mono text-sm">{{ empleado?.nroDoc }}</span>
          </td>
        </ng-container>

        <!-- Fecha y hora mejorada -->
        <ng-container matColumnDef="punch_time">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Fecha y Hora
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <div class="flex flex-col">
              <span class="font-medium text-fiori-text">{{ formatearFecha(m.punch_time) }}</span>
              <span class="text-sm text-fiori-subtext">{{ formatearHora(m.punch_time) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Estado con mejor diseño -->
        <ng-container matColumnDef="punch_state">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Estado
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                  [class]="m.punch_state === '0' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
              <mat-icon class="text-base mr-1">
                {{ m.punch_state === '0' ? 'login' : 'logout' }}
              </mat-icon>
              {{ m.punch_state === '0' ? 'Entrada' : 'Salida' }}
            </span>
          </td>
        </ng-container>

        <!-- Terminal -->
        <ng-container matColumnDef="terminal_alias">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Terminal
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <div class="flex flex-col">
              <span class="font-medium text-fiori-text">{{ m.terminal_alias }}</span>
              <span class="text-sm text-fiori-subtext font-mono">{{ m.terminal_sn }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Área -->
        <ng-container matColumnDef="area_alias">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Área
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 text-blue-800 text-sm">
              <mat-icon class="text-base mr-1">business</mat-icon>
              {{ empleado?.areaDescripcion }}
            </span>
          </td>
        </ng-container>

        <!-- Tipo verificación -->
        <ng-container matColumnDef="verify_type">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Verificación
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <span class="inline-flex items-center px-2 py-1 rounded-md bg-purple-100 text-purple-800 text-sm">
              <mat-icon class="text-base mr-1">
                {{ getVerifyIcon(m.verify_type) }}
              </mat-icon>
              {{ getVerifyText(m.verify_type) }}
            </span>
          </td>
        </ng-container>

        <!-- Llegó a tiempo (solo si hay horarios) -->
        <ng-container *ngIf="tieneHorarios" matColumnDef="llegoATiempo">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4">
            Llegó a tiempo
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4">
            <span *ngIf="m.llegoATiempo === 'a_tiempo'" class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
              <mat-icon class="text-base mr-1">check_circle</mat-icon> A tiempo
            </span>
            <span *ngIf="m.llegoATiempo === 'tarde'" class="inline-flex items-center px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-semibold">
              <mat-icon class="text-base mr-1">error</mat-icon> Tarde
            </span>
            <span *ngIf="m.llegoATiempo === 'sin_horario'" class="inline-flex items-center px-2 py-1 rounded-full bg-gray-200 text-gray-600 text-xs font-semibold">
              <mat-icon class="text-base mr-1">help</mat-icon> Sin horario
            </span>
          </td>
        </ng-container>

        <!-- Horario asignado -->
        <ng-container matColumnDef="horarioAsignado">
          <th mat-header-cell *matHeaderCellDef class="bg-fiori-muted font-semibold text-fiori-text px-6 py-4 min-w-[150px] max-w-[200px]">
            Horario Asignado
          </th>
          <td mat-cell *matCellDef="let m" class="px-6 py-4 min-w-[150px] max-w-[200px]">
            <div *ngIf="horarios && horarios.length > 0" class="flex flex-col">
              <span class="font-medium text-fiori-text text-sm truncate">{{ getHorarioAsignado()?.alias || 'Sin horario' }}</span>
              <div class="flex flex-col text-xs text-fiori-subtext">
                <span>Entrada: {{ getHorarioAsignado()?.inTime || '' }}</span>
                <span>Salida: {{ getHorarioAsignado()?.outTime || '' }}</span>
              </div>
            </div>
            <span *ngIf="!horarios || horarios.length === 0" class="text-sm text-fiori-subtext">Sin horario asignado</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
            class="hover:bg-fiori-hover transition-colors duration-200"></tr>
      </table>
    </div>

    <!-- Estado vacío o con mensaje -->
    <div *ngIf="mensajeSinMarcaciones" class="text-center py-16">
      <div class="flex flex-col items-center gap-4">
        <mat-icon class="text-6xl text-fiori-subtext">schedule</mat-icon>
        <h3 class="text-lg font-medium text-fiori-text">{{ mensajeSinMarcaciones }}</h3>
        <p class="text-fiori-subtext max-w-md">
          {{ getMensajeAyuda() }}
        </p>
        <button mat-stroked-button (click)="reiniciarBusqueda()" class="mt-2" *ngIf="fechaInicio && fechaFin">
          <mat-icon>refresh</mat-icon>
          Reintentar búsqueda
        </button>
      </div>
    </div>
  </div>

  <!-- Paginación (opcional) -->
  <div class="mt-6 flex justify-center" *ngIf="marcaciones.length > 25">
    <div class="text-center text-sm text-fiori-subtext">
      Mostrando {{ marcaciones.length }} marcaciones
    </div>
  </div>
</div>