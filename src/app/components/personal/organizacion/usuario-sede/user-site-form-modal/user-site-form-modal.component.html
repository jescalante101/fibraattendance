<!-- Container con tema Fiori -->
<div class="bg-fiori-surface rounded-lg shadow-fioriSm border border-fiori-border overflow-hidden">
  <!-- Header -->
  <div class="bg-fiori-muted border-b border-fiori-border px-6 py-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
        <lucide-icon [name]="isEditMode ? 'user-pen' : 'user-plus'" class="w-4 h-4 text-fiori-primary"></lucide-icon>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-fiori-text">{{ isEditMode ? 'Editar Asignación' : 'Nueva Asignación' }}</h2>
        <p class="text-sm text-fiori-subtext">{{ isEditMode ? 'Modifica la asignación usuario-sede' : 'Registra una nueva asignación usuario-sede' }}</p>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 space-y-4">
    
    <!-- Campo Usuario with Autocomplete -->
    <div class="relative">
      <label for="usuarioFilter" class="block text-sm font-medium text-fiori-text mb-2">
        <lucide-icon name="user" class="w-4 h-4 inline mr-1"></lucide-icon>
        Usuario <span class="text-fiori-error">*</span>
      </label>
      <div class="relative">
        <input 
          type="text" 
          id="usuarioFilter"
          formControlName="usuarioFilter"
          (input)="onUsuarioFilterChange($event); form.get('userId')?.setValue('')"
          (focus)="showUsuarioDropdown = true"
          (blur)="onUsuarioBlur()"
          placeholder="Buscar usuario..."
          class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-lg bg-fiori-surface text-fiori-text focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all"
          [class.border-fiori-error]="form.get('userId')?.hasError('required') && form.get('userId')?.touched">
        <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
          <lucide-icon name="user" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
        </div>
        
        <!-- Dropdown de usuarios -->
        <div *ngIf="showUsuarioDropdown && filteredUsuarios && filteredUsuarios.length > 0" 
             class="absolute z-50 w-full mt-1 bg-fiori-surface border border-fiori-border rounded-lg shadow-fioriHover max-h-60 overflow-y-auto">
          <div *ngFor="let usuario of filteredUsuarios; trackBy: trackByUserId" 
               (mousedown)="onUsuarioSelected(usuario)"
               class="px-4 py-3 hover:bg-fiori-hover cursor-pointer border-b border-fiori-border last:border-b-0 transition-colors">
            <div class="flex items-center space-x-3">
              <div class="w-6 h-6 bg-fiori-primary/10 rounded-lg flex items-center justify-center">
                <lucide-icon name="user" class="w-3 h-3 text-fiori-primary"></lucide-icon>
              </div>
              <div>
                <div class="text-sm font-medium text-fiori-text">{{ usuario.userName }}</div>
                <div class="text-xs text-fiori-subtext">ID: {{ usuario.userId }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <p *ngIf="form.get('userId')?.hasError('required') && form.get('userId')?.touched" 
         class="text-xs text-fiori-error mt-1">
        <lucide-icon name="alert-circle" class="w-3 h-3 inline mr-1"></lucide-icon>
        Debe seleccionar un usuario
      </p>
    </div>

    <!-- Campo Sede with Autocomplete -->
    <div class="relative">
      <label for="sedeFilter" class="block text-sm font-medium text-fiori-text mb-2">
        <lucide-icon name="map-pin" class="w-4 h-4 inline mr-1"></lucide-icon>
        Sede <span class="text-fiori-error">*</span>
      </label>
      <div class="relative">
        <input 
          type="text" 
          id="sedeFilter"
          formControlName="sedeFilter"
          (input)="onSedeFilterChange($event); form.get('siteId')?.setValue('')"
          (focus)="showSedeDropdown = true"
          (blur)="onSedeBlur()"
          placeholder="Buscar sede..."
          class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-lg bg-fiori-surface text-fiori-text focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all"
          [class.border-fiori-error]="(form.get('siteId')?.hasError('sedeRequired') || form.get('siteId')?.hasError('required')) && form.get('siteId')?.touched">
        <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
          <lucide-icon name="map-pin" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
        </div>
        
        <!-- Dropdown de sedes -->
        <div *ngIf="showSedeDropdown && filteredSedes && filteredSedes.length > 0" 
             class="absolute z-50 w-full mt-1 bg-fiori-surface border border-fiori-border rounded-lg shadow-fioriHover max-h-60 overflow-y-auto">
          <div *ngFor="let sede of filteredSedes; trackBy: trackBySedeId" 
               class="px-4 py-3 hover:bg-fiori-hover cursor-pointer border-b border-fiori-border last:border-b-0 transition-colors">
            <div class="flex items-center space-x-3" 
                 (mousedown)="toggleSedeSelectionFromClick(sede)">
              <!-- Checkbox para selección múltiple -->
              <input 
                type="checkbox" 
                [checked]="isSedeSelected(sede)"
                (change)="toggleSedeSelection(sede, $event)"
                (mousedown)="$event.stopPropagation()"
                class="w-4 h-4 text-fiori-primary bg-fiori-surface border-fiori-border rounded focus:ring-fiori-primary focus:ring-2 transition-colors">
              
              <div class="w-6 h-6 bg-fiori-info/10 rounded-lg flex items-center justify-center">
                <lucide-icon name="map-pin" class="w-3 h-3 text-fiori-info"></lucide-icon>
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium text-fiori-text">{{ sede.descripcion }}</div>
                <div class="text-xs text-fiori-subtext">ID: {{ sede.categoriaAuxiliarId }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mostrar sedes seleccionadas -->
      <div *ngIf="selectedSedes && selectedSedes.length > 0" class="mt-3">
        <div class="flex flex-wrap gap-2">
          <div *ngFor="let sede of selectedSedes" 
               class="inline-flex items-center gap-2 px-3 py-1.5 bg-fiori-info/10 text-fiori-info border border-fiori-info/20 rounded-lg text-sm">
            <lucide-icon name="map-pin" class="w-3 h-3"></lucide-icon>
            <span>{{ sede.descripcion }}</span>
            <button 
              type="button"
              (click)="removeSedeSelection(sede)"
              class="hover:text-fiori-error transition-colors">
              <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
            </button>
          </div>
        </div>
      </div>
      
      <p *ngIf="(form.get('siteId')?.hasError('sedeRequired') || form.get('siteId')?.hasError('required')) && form.get('siteId')?.touched" 
         class="text-xs text-fiori-error mt-1">
        <lucide-icon name="alert-circle" class="w-3 h-3 inline mr-1"></lucide-icon>
        Debe seleccionar al menos una sede
      </p>
    </div>

    <!-- Campo Fecha de creación -->
    <div>
      <label for="creationDate" class="block text-sm font-medium text-fiori-text mb-2">
        <lucide-icon name="calendar" class="w-4 h-4 inline mr-1"></lucide-icon>
        Fecha de creación
      </label>
      <div class="relative">
        <input 
          type="datetime-local" 
          id="creationDate"
          formControlName="creationDate"
          readonly
          class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-lg bg-fiori-muted text-fiori-subtext cursor-not-allowed">
        <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
          <lucide-icon name="calendar" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
        </div>
      </div>
    </div>

    <!-- Campo Observación -->
    <div>
      <label for="observation" class="block text-sm font-medium text-fiori-text mb-2">
        <lucide-icon name="file-text" class="w-4 h-4 inline mr-1"></lucide-icon>
        Observación
      </label>
      <div class="relative">
        <textarea 
          id="observation"
          formControlName="observation" 
          rows="3" 
          placeholder="Agregar comentarios adicionales..."
          class="w-full pl-10 pr-4 py-3 border border-fiori-border rounded-lg bg-fiori-surface text-fiori-text focus:ring-2 focus:ring-fiori-primary focus:border-fiori-primary transition-all resize-none"></textarea>
        <div class="absolute left-3 top-3">
          <lucide-icon name="file-text" class="w-4 h-4 text-fiori-subtext"></lucide-icon>
        </div>
      </div>
    </div>

  </form>
  
  <!-- Botones de acción con save button a la izquierda -->
  <div class="bg-fiori-surface rounded-b-lg shadow-fioriSm border-t border-fiori-border p-4">
    <div class="flex justify-end gap-3">
      <button 
        type="submit" 
        (click)="onSubmit()"
        [disabled]="form.invalid || loading"
        class="inline-flex items-center px-4 py-2 bg-fiori-primary text-white text-sm font-medium rounded-lg hover:bg-fiori-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <!-- Loading spinner -->
        <div *ngIf="loading" class="w-4 h-4 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
        <lucide-icon *ngIf="!loading" [name]="isEditMode ? 'save' : 'plus'" class="w-4 h-4 mr-2"></lucide-icon>
        {{ isEditMode ? 'Actualizar' : 'Registrar' }}
      </button>
      <button 
        type="button" 
        (click)="onCancel()"
        class="inline-flex items-center px-4 py-2 bg-fiori-muted text-fiori-subtext text-sm font-medium rounded-lg hover:bg-fiori-hover transition-colors">
        <lucide-icon name="x" class="w-4 h-4 mr-2"></lucide-icon>
        Cancelar
      </button>
    </div>
  </div>
</div>