<div class="relative">
  <!-- Botón del Column Manager -->
  <button
    #popoverButton
    type="button"
    (click)="togglePopover()"
    class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    [class.bg-blue-50]="showPopover"
    [class.text-blue-700]="showPopover"
    [class.ring-2]="showPopover"
    [class.ring-blue-500]="showPopover"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125Z" />
    </svg>
    {{ config.title || 'Columnas' }}
    <span class="ml-1 text-xs text-gray-500">({{ visibleCount }}/{{ totalCount }})</span>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2" [class.rotate-180]="showPopover">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
    </svg>
  </button>

  <!-- Popover del Column Manager -->
  <div
    #popoverContent
    *ngIf="showPopover"
    [ngClass]="getPopoverClasses()"
  >
    <!-- Header del popover -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-gray-900">
          {{ config.title || 'Gestionar Columnas' }}
        </h3>
        <button
          (click)="closePopover()"
          class="p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Buscador (si está habilitado) -->
      <div *ngIf="config.searchable" class="relative mb-3">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange($event)"
          placeholder="Buscar columnas..."
          class="w-full pl-8 pr-3 py-2 text-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent"
        />
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-gray-400 absolute left-2.5 top-1/2 transform -translate-y-1/2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
      </div>

      <!-- Seleccionar todo (si está habilitado) -->
      <div *ngIf="config.showSelectAll" class="flex items-center">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            [checked]="allSelected"
            [indeterminate]="indeterminate"
            (change)="onSelectAllChange($event)"
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-xs text-gray-700 font-medium">
            Seleccionar Todo
          </span>
        </label>
      </div>
    </div>

    <!-- Lista de columnas -->
    <div class="p-2 max-h-80 overflow-y-auto">
      <!-- Vista agrupada -->
      <div *ngIf="config.groupByCategory && groups.length > 0">
        <div *ngFor="let group of groups" class="mb-3">
          <!-- Encabezado del grupo -->
          <button
            (click)="toggleGroup(group)"
            class="w-full flex items-center justify-between p-2 text-xs font-medium text-gray-600 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
          >
            <span>{{ group.name }} ({{ group.columns.length }})</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3" [class.rotate-90]="!group.collapsed">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          <!-- Columnas del grupo -->
          <div *ngIf="!group.collapsed" class="ml-2 mt-2 space-y-1">
            <div *ngFor="let column of group.columns" class="flex items-center p-2 hover:bg-gray-50 rounded-lg">
              <label class="flex items-center cursor-pointer flex-1" [class.opacity-50]="column.required">
                <input
                  type="checkbox"
                  [checked]="column.visible"
                  [disabled]="column.required"
                  (change)="onColumnToggle(column)"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <div class="ml-2 flex-1">
                  <div class="text-xs font-medium text-gray-900">
                    {{ column.label }}
                    <span *ngIf="column.required" class="text-xs text-gray-500">(requerido)</span>
                  </div>
                  <div class="text-xs text-gray-500">{{ column.key }}</div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista simple (sin grupos) -->
      <div *ngIf="!config.groupByCategory || groups.length === 0" class="space-y-1">
        <div *ngFor="let column of filteredColumns" class="flex items-center p-2 hover:bg-gray-50 rounded-lg">
          <label class="flex items-center cursor-pointer flex-1" [class.opacity-50]="column.required">
            <input
              type="checkbox"
              [checked]="column.visible"
              [disabled]="column.required"
              (change)="onColumnToggle(column)"
              class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <div class="ml-2 flex-1">
              <div class="text-xs font-medium text-gray-900">
                {{ column.label }}
                <span *ngIf="column.required" class="text-xs text-gray-500">(requerido)</span>
              </div>
              <div class="text-xs text-gray-500">{{ column.key }}</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="filteredColumns.length === 0" class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400 mx-auto mb-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125Z" />
        </svg>
        <p class="text-xs text-gray-500">No se encontraron columnas</p>
      </div>
    </div>

    <!-- Footer del popover -->
    <div class="p-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
      <div class="flex items-center justify-between space-x-2">
        <!-- Información de estado -->
        <div class="text-xs text-gray-600">
          {{ visibleCount }} de {{ totalCount }} columnas visibles
        </div>
        
        <!-- Botones de acción -->
        <div class="flex space-x-2">
          <button
            *ngIf="config.showReset"
            (click)="onResetColumns()"
            class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Restaurar
          </button>
          <button
            (click)="onApplyColumns()"
            class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Aplicar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>